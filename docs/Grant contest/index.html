<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-timer.v1.min.js"></script>
    <style type="text/css">
body,html{
    margin: 0;
    padding: 0;
    font-family: "Arial", sans-serif;
    font-size: 11px;
    text-align: center;
  }

  #chart{
    background-color: white;
    border: 0px solid #CCC;
  }

  .option button{
    border: white;
    text-decoration: underline;
    border-color: white;
    outline: none;
    background: none;
    cursor: pointer;
    font-size: 15px;
    margin: 13px;
    color: black;
    border-radius: 0px;
  }

  #action{
    border: grey;
    background-color: grey;
    color: white;
    font-size: 15px;
    cursor: pointer;
    }
    button:focus {outline:0;}


    input{
      color: blue;
    }


  input[type=range]::-webkit-slider-runnable-track {
     -webkit-appearance: none;
    width: 300px;
    height: 5px;
    background: black;
    border: none;
    border-radius: 3px;
}

/*#menu::-webkit-slider-thumb {
    border: none;
    height: 16px;
    width: 16px;
    background-color: black;
    margin-top: -5px;
}*/
input[type=range]::-webkit-slider-thumb{
    -webkit-appearance: none;
    background: black;
    border: 1px solid #CECECE;
    height: 15px;
    width: 15px;
    margin-top: -5px;
    color: black;
    fill: black;
}

.years{
  font-size: 15px;
  font-weight: bold;

}

.slider_years{
  font-size: 15px;
  font-weight: bold;
}



    </style>
  </head>
  <body>
<div id = "content">
<h1 style="font-size: 25px;"> Explore the themes the top 10 funders funded through the years</h1>
<br>
<p style="font-size: 15px;"> By: Julien Assouline </p>
<br>
<div class= "option">
<button id = "sports"> Sports</button>
<button id = "health"> Health </button>
<button id = "education"> Education </button>
<button id = "arts"> Arts </button>
<button id = "transportation">Transportation</button>
<button id = "environment">Environment</button>
<button id = "science">Science</button>
<button id = "homelessness">Homelessness</button>
<button id = "veterans">Veterans</button>
</div>
<br></br>
<button id = "action"> Play </button>
<input id="menu" class = "slider" type="range" min="2004" max="2018"  step="1" value="2004">
<div id = "pack"></div>
</div>
<script>



var h = 800;
var w = 1000;



var margin = {
  right: 40,
  left: 40,
  top: 40,
  bottom: 40
}

var width = w - margin.right - margin.left;
var height = h - margin.top - margin.bottom;

var svg = d3.select("#pack")
  .append("svg")
  .attr("id", "chart")
  .attr("width", w)
  .attr("height", h)



  var colorCircle = d3.scaleOrdinal()
          .domain([0,1,2])
          .range(['#b96666','#8b0000']);

      var colorCircleHealth = d3.scaleOrdinal()
      .domain([0,1,2])
      .range(['#75ddcd','#52c2cb']);

     var colorCircleEducation = d3.scaleOrdinal()
      .domain([0,1,2])
      .range(['#bcc0ae','#9b9f83']);

    var colorCircleArts = d3.scaleOrdinal()
      .domain([0,1,2])
      .range(['lightgrey','grey']);

    var colorCircleTransportation = d3.scaleOrdinal()
      .domain([0,1,2])
      .range(['#c68c53','#996633']);

    var colorCircleEnvironment = d3.scaleOrdinal()
      .domain([0,1,2])
      .range(['#5ca85c','#178317']);

    var colorCircleScience = d3.scaleOrdinal()
      .domain([0,1,2])
      .range(['#9975b9','#551a8b']);

    var colorCircleHomelessness = d3.scaleOrdinal()
      .domain([0,1,2])
      .range(['#b26666','#800000']);

    var colorCircleVeterans = d3.scaleOrdinal()
      .domain([0,1,2])
      .range(['#000080','#6666b2']);

      var timer;


           d3.csv("df_grants_theme_grouped_top10.csv", function(error, data){
            data.forEach(function(d){
              d["Amount Awarded"] = +d["Amount Awarded"]
              d["Award Year"] = +d["Award Year"]
            })

            for(var i = 0; i < data.length; i++) {
              delete data[i][""];
            }

           var sizeScale = d3.scaleSqrt()
              .range([20,50]);

            var packLayout = d3.pack()
              .padding(2)
              .size([1000, 700])

              // packLayout.radius(function(){ return 3;  })

          var years;


          var g = d3.select("svg")
                .append("g")
                // .attr("transform", "translate(" + w/2+ ",0)")

        d3.select("#sports").style("background-color", "#b96666").style("color", "white")


        function drawInitialPackSports(){
          years = d3.range(2004, 2019)

          var filter_data = data.filter(function(d) {
            return (d["Award Year"] == years[0]) && (d["Theme"] == "Sports")
          })

          var nested_grants = d3.nest()
            .key(function(d) { return d["Funding Org:Name"]})
            .key(function(d) { return d["Recipient Org:Name"] })
            .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
            .entries(filter_data)

            var packableGrants = {key: "All Grants", values: nested_grants}

            var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                            .sum(function(d) { return d.value })
                            .sort(function(a, b) { return b.value - a.value; })

              var sizeScale = d3.scaleSqrt()
              .range([0.0001,0.01]);

              packLayout.radius(d=>sizeScale(d.value));


              var data_nodes = packLayout(rootNode).descendants()
              pack.radius
              g.selectAll("circle")
              .data(data_nodes)
              .enter()
              .append("circle")
              .attr("class", "circle_packs")
              .attr("r", function(d) { return 0 })
              .attr("cx", function(d) { return d.x })
              .attr("cy", function(d) { return  d.y })
              .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
              .transition()
              .duration(1000)
              .attr("r", function(d) { return d.r });



              g.selectAll(".text")
                .data(data_nodes.filter(function(d) { return !!d.children }))
                .enter()
                .append("text")
                .attr("x", function(d) { return d.x })
                .attr("y", function(d) { return d.y })
                .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                .text(function(d){ return d.data.key })
                .style("fill", "none")
                .attr("text-anchor", "middle")
                .attr("class", "labels_background")
                .style("font-size", 15)
                .style("stroke-width", 15*0.2)
                .style("stroke", function(d) {
                  if(d.r < 30) return "none";
                  else return "#ffffff";
                })
                .style("opacity", 0)
                .transition()
                .duration(1000)
                .style("opacity", 1);

                g.append("text")
                .attr("class", "years")
                .attr("x", w / 2)
                .attr("y", 20)
                .text(years[0])


              g.selectAll(".labels")
                .data(data_nodes.filter(function(d) { return !!d.children }))
                .enter()
                .append("text")
                .attr("x", function(d) { return d.x })
                .attr("y", function(d) { return d.y })
                .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                .text(function(d){ return d.data.key })
                .style("fill", function(d) {
                  if(d.r < 30) return "none";
                  else return "black";
                })
                .attr("class", "labels_text")
                .attr("text-anchor", "middle")
                .style("font-size", 15)
                .style("opacity", 0)
                .transition()
                .duration(1000)
                .style("opacity", 1)

                g.append("text")
                  .attr("x", 90)
                  .attr("y", 100)
                  .text("Total amount in grants awarded")
                  .attr("class", "legend_text")
                  .style("font-size", 15)

                g.append("circle")
                  .attr("r", 6)
                  .attr("cx", 80)
                  .attr("cy", 95)
                  .attr("fill", "#b96666")



                g.append("line")
                  .attr("x1", 310.5)
                  .attr("y1", 95)
                  .attr("x2", 410)
                  .attr("y2", 95.5)
                  .style("stroke", "black")
                  .style("fill", "none")




                g.append("text")
                  .attr("x", 100)
                  .attr("y", 300)
                  .text("Funders")
                  .attr("class", "legend_text")
                  .style("font-size", 15)

                g.append("line")
                  .attr("x1", 160)
                  .attr("y1", 295.5)
                  .attr("x2", 243)
                  .attr("y2", 295.5)
                  .style("stroke", "black")
                  .style("fill", "none")

                  g.append("circle")
                  .attr("r", 6)
                  .attr("cx", 80)
                  .attr("cy", 295)
                  .attr("fill", "#8b0000")

                g.append("text")
                  .attr("x", 100)
                  .attr("y", 400)
                  .text("Recipients")
                  .attr("class", "legend_text")
                  .style("font-size", 15)

                g.append("line")
                  .attr("x1", 180)
                  .attr("y1", 395.5)
                  .attr("x2", 270)
                  .attr("y2", 395.5)
                  .style("stroke", "black")
                  .style("fill", "none")

                g.append("circle")
                  .attr("r", 6)
                  .attr("cx", 80)
                  .attr("cy", 395)
                  .attr("fill", "white")
                  .attr("stroke", "black")



                /// button play


        } // drawInitialPack

        drawInitialPackSports();

        var playButton = d3.select("#action")

        playButton.on("click", function() {
          d3.selectAll(".legend_text")
                  .remove();
          d3.selectAll("line").remove()
          var button = d3.select(this)
           // if(timer == undefined) {
              if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }
            timer = d3.interval(transitionSports, 3000)

              function transitionSports() {

                 var new_filtered_data = data.filter(function(d) {
                       return (d["Award Year"] == years[counter]) && (d["Theme"] == "Sports")
                      })

                var something = document.getElementById("menu").value = years[counter]

                var new_nested_grants = d3.nest()
                  .key(function(d) { return d["Funding Org:Name"]})
                  .key(function(d) { return d["Recipient Org:Name"] })
                  .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                  .entries(new_filtered_data)

                  var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                  var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                  .sum(function(d) { return d.value })
                                  .sort(function(a, b) { return b.value - a.value; })

                    var new_data_nodes = packLayout(newRootNode).descendants()

                  var circle = g.selectAll("circle")
                     .data(new_data_nodes)

                   var text_background = g.selectAll(".text")
                       .data(new_data_nodes.filter(function(d) { return !!d.children }))

                   var text = g.selectAll(".labels")
                       .data(new_data_nodes.filter(function(d) { return !!d.children }))

                        if(g.select(".years")._groups[0][0]) {
                          g.select(".years")
                            .attr("x", w / 2)
                            .attr("y", 20)
                            .text(years[counter])
                        }
                        else {
                          g.append("text")
                            .attr("class", "years")
                            .attr("x", w / 2)
                            .attr("y", 20)
                            .text(years[counter])
                        }

                            if (years[counter] == 2010) {
                          g.append("text")
                            .attr("x",  0)
                            .attr("y", 50)
                            .text("The theme with the most grants awarded was sports.")
                            .style("font-size", 15)
                            .style("opacity", 0)
                            .transition()
                            .duration(2000)
                            .style("opacity", 1)

                          g.append("text")
                            .attr("x",  0)
                            .attr("y", 70)
                            .text("The two dominant funders were Sport England and The Big Lottery Fund.")
                            .style("font-size", 15)
                            .style("opacity", 0)
                            .transition()
                            .duration(2000)
                            .style("opacity", 1)

                        }
                        else if (years[counter] == 2018) {
                          g.append("text")
                               .attr("x",  0)
                               .attr("y", 90)
                               .text("No funds thus far in 2018 for sports.")
                               .style("font-size", 15)
                               .style("opacity", 0)
                               .attr("class", "sports_2018_text")
                               .transition()
                               .duration(2000)
                               .style("opacity", 1)
                        }


                var circleTransition =  d3.transition()
                     .duration(1000)

                 var textTransition = d3.transition()
                     .duration(1000)

                 // exit
                 circle.exit()
                     .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
                     .transition(circleTransition)
                     .attr("r", function(d) { return 0 })
                     .remove()

                   d3.selectAll(".labels_text")
                   .remove();

                   d3.selectAll(".labels_background")
                   .remove();

                   d3.selectAll(".slider_years")
                   .remove()

                  d3.selectAll(".legend_text")
                  .remove();

                   // d3.selectAll(".years")
                   // .remove()

                 // update
                 circle.transition(circleTransition)
                     .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
                     .attr("class", "circle_packs")
                     .attr("r", function(d) { return d.r })
                     .attr("cx", function(d) { return d.x })
                     .attr("cy", function(d) { return  d.y })
                     .style("opacity", 1)

                 text_background.transition(textTransition)
                     .attr("x", function(d){ return d.x; })
                     .attr("y", function(d){ return d.y; });

                   text.transition(textTransition)
                     .attr("x", function(d){ return d.x; })
                     .attr("y", function(d){ return d.y; });

                   //enter
                   circle.enter()
                   .append("circle")
                   .attr("r", function(d) { return 0 })
                   .attr("cx", function(d) { return d.x })
                   .attr("cy", function(d) { return  d.y })
                   .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
                   .transition(circleTransition)
                   .attr("r", function(d) { return d.r })
                   .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })

                   text_background.enter()
                     .append("text")
                     .attr("opacity", 0)
                     .attr("class", "labels_background")
                     .attr("x", function(d) { return d.x })
                     .attr("y", function(d) { return d.y })
                     .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                     .text(function(d){ return d.data.key })
                     .style("fill", "none")
                     .style("font-size", 15)
                     .style("stroke-width", 15*0.2)
                     .style("stroke", function(d) {
                       if(d.r < 30) return "none";
                       else return "#ffffff";
                     })
                     .attr("text-anchor", "middle")
                     .transition(textTransition)
                     .style("opacity", 1)

                     text.enter()
                       .append("text")
                       .attr("opacity", 0)
                       .attr("class", "labels_text")
                       .attr("x", function(d) { return d.x })
                       .attr("y", function(d) { return d.y })
                       .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                       .text(function(d){ return d.data.key })
                       .style("fill", function(d) {
                         if(d.r < 30) return "none";
                         else return "black";
                       })
                       .attr("text-anchor", "middle")
                       .style("font-size", 15)
                       .transition(textTransition)
                       .style("opacity", 1)

                     counter += 1
                     if (counter === years.length) {
                      timer.stop()
                     }
             }// transition
            // }
            // else {
            //   timer.stop()
            // }
            d3.select("#action")
              .on("click", function() {
                timer.stop()
              })



        }) // action



          function drawFilteredPack(){
            d3.selectAll("circle")
            .remove()

            d3.selectAll("text")
            .remove()
              d3.selectAll("line").remove()


            if(timer == undefined) {
            }
            else {
              timer.stop()
            }

            var selectedYear = document.getElementById("menu").value;

            var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Sports") })


            var nested_grants = d3.nest()
              .key(function(d) { return d["Funding Org:Name"]})
              .key(function(d) { return d["Recipient Org:Name"] })
              .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
              .entries(filteredDataYear)

              var packableGrants = {key: "All Grants", values: nested_grants}

              var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                              .sum(function(d) { return d.value })
                              .sort(function(a, b) { return b.value - a.value; })

               var data_nodes = packLayout(rootNode).descendants()




              g.selectAll("circle")
              .data(data_nodes)
              .enter()
              .append("circle")
              .attr("r", function(d) {
                 return 0;
               })
              .attr("cx", function(d) { return d.x })
              .attr("cy", function(d) { return  d.y })
              .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
              .style("opacity", 0)
              .transition()
              .duration(1000)
              .attr("r", function(d) { return d.r })
              .style("opacity", 1)




              g.selectAll(".text")
                .data(data_nodes.filter(function(d) { return !!d.children }))
                .enter()
                .append("text")
                .attr("x", function(d) { return d.x  })
                .attr("y", function(d) { return d.y })
                .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                .text(function(d){ return d.data.key })
                .style("fill", "none")
                .attr("class", "labels_background")
                .style("font-size", 15)
                .style("stroke-width", 15*0.2)
                .style("stroke", function(d) {
                  if(d.r < 30) return "none";
                  else return "#ffffff";
                })
                .attr("text-anchor", "middle")
                .style("opacity", 0)
                .transition()
                .duration(1000)
                .style("opacity", 1)


              g.selectAll(".labels")
                .data(data_nodes.filter(function(d) { return !!d.children }))
                .enter()
                .append("text")
                .attr("x", function(d) { return d.x })
                .attr("y", function(d) { return d.y })
                .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                .text(function(d){ return d.data.key })
                .style("fill", function(d) {
                  if(d.r < 30) return "none";
                  else return "black";
                })
                .attr("class", "labels_text")
                .attr("text-anchor", "middle")
                .style("font-size", 15)
                .raise()
                .style("opacity", 0)
                .transition()
                .duration(1000)
                .style("opacity", 1);

                g.append("text")
                      .attr("class", "slider_years")
                      .attr("x", w / 2)
                      .attr("y", 20)
                      .text(selectedYear)




          }

          d3.select("#menu")
            .on("input", function() {
              drawFilteredPack();
            })

      // SPORTs

        d3.select("#sports").on("click", function() {
          d3.selectAll("circle")
          .remove()
          d3.selectAll("text")
          .remove()
           d3.selectAll("line").remove()

          if(timer == undefined) {
          }
          else {
            timer.stop()
          }
          document.getElementById("menu").value = 2004

          d3.select("#sports").style("background-color", "#b96666").style("color", "white")
          d3.select("#health").style("background-color", "white").style("color", "black")
          d3.select("#education").style("background-color", "white").style("color", "black")
          d3.select("#arts").style("background-color", "white").style("color", "black")
          d3.select("#transportation").style("background-color", "white").style("color", "black")
          d3.select("#environment").style("background-color", "white").style("color", "black")
          d3.select("#science").style("background-color", "white").style("color", "black")
          d3.select("#homelessness").style("background-color", "white").style("color", "black")
          d3.select("#veterans").style("background-color", "white").style("color", "black")


          function drawInitialPack(){
            years = d3.range(2004, 2019)

            var filter_data = data.filter(function(d) {
              return (d["Award Year"] == years[0]) && (d["Theme"] == "Sports")
            })

            var nested_grants = d3.nest()
              .key(function(d) { return d["Funding Org:Name"]})
              .key(function(d) { return d["Recipient Org:Name"] })
              .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
              .entries(filter_data)

              var packableGrants = {key: "All Grants", values: nested_grants}

              var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                              .sum(function(d) { return d.value })
                              .sort(function(a, b) { return b.value - a.value; })

                var sizeScale = d3.scaleSqrt()
                .range([0.0001,0.01]);

                packLayout.radius(d=>sizeScale(d.value));


                var data_nodes = packLayout(rootNode).descendants()
                g.selectAll("circle")
                .data(data_nodes)
                .enter()
                .append("circle")
                .attr("class", "circle_packs")
                .attr("r", function(d) { return 0 })
                .attr("cx", function(d) { return d.x })
                .attr("cy", function(d) { return  d.y })
                .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
                .transition()
                .duration(1000)
                .attr("r", function(d) { return d.r })



                g.selectAll(".text")
                  .data(data_nodes.filter(function(d) { return !!d.children }))
                  .enter()
                  .append("text")
                  .attr("x", function(d) { return d.x })
                  .attr("y", function(d) { return d.y })
                  .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                  .text(function(d){ return d.data.key })
                  .style("fill", "none")
                  .attr("text-anchor", "middle")
                  .attr("class", "labels_background")
                  .style("font-size", 15)
                  .style("stroke-width", 15*0.2)
                  .style("stroke", function(d) {
                    if(d.r < 30) return "none";
                    else return "#ffffff";
                  })
                  .style("opacity", 0)
                  .transition()
                  .duration(1000)
                  .style("opacity", 1)

                  g.append("text")
                  .attr("class", "years")
                  .attr("x", w / 2)
                  .attr("y", 20)
                  .text(years[0])


                g.selectAll(".labels")
                  .data(data_nodes.filter(function(d) { return !!d.children }))
                  .enter()
                  .append("text")
                  .attr("x", function(d) { return d.x })
                  .attr("y", function(d) { return d.y })
                  .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                  .text(function(d){ return d.data.key })
                  .style("fill", function(d) {
                    if(d.r < 30) return "none";
                    else return "black";
                  })
                  .attr("class", "labels_text")
                  .attr("text-anchor", "middle")
                  .style("font-size", 15)
                  .style("opacity", 0)
                  .transition()
                  .duration(1000)
                  .style("opacity", 1)


                  /// button play


          } // drawInitialPack

          drawInitialPack();

          var playButton = d3.select("#action")

          playButton.on("click", function() {
            var button = d3.select(this)
             // if(timer == undefined) {
                if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }
              timer = d3.interval(transitionSports, 3000)





                function transitionSports() {
                  d3.selectAll("line").remove()

                   var new_filtered_data = data.filter(function(d) {
                         return (d["Award Year"] == years[counter]) && (d["Theme"] == "Sports")
                        })

                  var something = document.getElementById("menu").value = years[counter]

                  var new_nested_grants = d3.nest()
                    .key(function(d) { return d["Funding Org:Name"]})
                    .key(function(d) { return d["Recipient Org:Name"] })
                    .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                    .entries(new_filtered_data)

                    var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                    var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                    .sum(function(d) { return d.value })
                                    .sort(function(a, b) { return b.value - a.value; })

                      var new_data_nodes = packLayout(newRootNode).descendants()

                    var circle = g.selectAll("circle")
                       .data(new_data_nodes)

                     var text_background = g.selectAll(".text")
                         .data(new_data_nodes.filter(function(d) { return !!d.children }))

                     var text = g.selectAll(".labels")
                         .data(new_data_nodes.filter(function(d) { return !!d.children }))

                          if(g.select(".years")._groups[0][0]) {
                            g.select(".years")
                              .attr("x", w / 2)
                              .attr("y", 20)
                              .text(years[counter])
                          }
                          else {
                            g.append("text")
                              .attr("class", "years")
                              .attr("x", w / 2)
                              .attr("y", 20)
                              .text(years[counter])
                          }

                          if (years[counter] == 2010) {
                        g.append("text")
                          .attr("x",  0)
                          .attr("y", 50)
                          .text("The theme with the most grants awarded was sports.")
                          .style("font-size", 15)
                          .attr("class", "science_label")
                          .style("opacity", 0)
                          .transition()
                          .duration(2000)
                          .style("opacity", 1)

                        g.append("text")
                          .attr("x",  0)
                          .attr("y", 70)
                          .text("The two dominant funders were Sport England and The Big Lottery Fund.")
                          .style("font-size", 15)
                          .attr("class", "science_label")
                          .style("opacity", 0)
                          .transition()
                          .duration(2000)
                          .style("opacity", 1)
                      }

                      if (years[counter] == 2018) {
                        g.append("text")
                              .attr("x",  0)
                              .attr("y", 90)
                              .text("No funds thus far in 2018 for sports.")
                              .style("font-size", 15)
                              .style("opacity", 0)
                              .transition()
                              .duration(2000)
                              .style("opacity", 1)
                      }

                  var circleTransition =  d3.transition()
                       .duration(1000)

                   var textTransition = d3.transition()
                       .duration(1000)

                   // exit
                   circle.exit()
                       .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
                       .transition(circleTransition)
                       .attr("r", function(d) { return 0 })
                       .remove()

                     d3.selectAll(".labels_text")
                     .remove();

                     d3.selectAll(".labels_background")
                     .remove();

                     d3.selectAll(".slider_years")
                     .remove()

                     // d3.selectAll(".years")
                     // .remove()

                   // update
                   circle.transition(circleTransition)
                       .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
                       .attr("class", "circle_packs")
                       .attr("r", function(d) { return d.r })
                       .attr("cx", function(d) { return d.x })
                       .attr("cy", function(d) { return  d.y })
                       .style("opacity", 1)

                   text_background.transition(textTransition)
                       .attr("x", function(d){ return d.x; })
                       .attr("y", function(d){ return d.y; });

                     text.transition(textTransition)
                       .attr("x", function(d){ return d.x; })
                       .attr("y", function(d){ return d.y; });

                     //enter
                     circle.enter()
                     .append("circle")
                     .attr("r", function(d) { return 0 })
                     .attr("cx", function(d) { return d.x })
                     .attr("cy", function(d) { return  d.y })
                     .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
                     .transition(circleTransition)
                     .attr("r", function(d) { return d.r })
                     .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })

                     text_background.enter()
                       .append("text")
                       .attr("opacity", 0)
                       .attr("class", "labels_background")
                       .attr("x", function(d) { return d.x })
                       .attr("y", function(d) { return d.y })
                       .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                       .text(function(d){ return d.data.key })
                       .style("fill", "none")
                       .style("font-size", 15)
                       .style("stroke-width", 15*0.2)
                       .style("stroke", function(d) {
                         if(d.r < 30) return "none";
                         else return "#ffffff";
                       })
                       .attr("text-anchor", "middle")
                       .transition(textTransition)
                       .style("opacity", 1)

                       text.enter()
                         .append("text")
                         .attr("opacity", 0)
                         .attr("class", "labels_text")
                         .attr("x", function(d) { return d.x })
                         .attr("y", function(d) { return d.y })
                         .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                         .text(function(d){ return d.data.key })
                         .style("fill", function(d) {
                           if(d.r < 30) return "none";
                           else return "black";
                         })
                         .attr("text-anchor", "middle")
                         .style("font-size", 15)
                         .transition(textTransition)
                         .style("opacity", 1)

                       counter += 1
                       if (counter === years.length) {
                        timer.stop()
                       }
               }// transition
              // }
              // else {
              //   timer.stop()
              // }
              d3.select("#action")
                .on("click", function() {
                  timer.stop()
                })



          }) // action



            function drawFilteredPack(){
              d3.selectAll("circle")
              .remove()

              d3.selectAll("text")
              .remove()
              d3.selectAll("line").remove()

              if(timer == undefined) {
              }
              else {
                timer.stop()
              }

              var selectedYear = document.getElementById("menu").value;

              var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Sports") })


              var nested_grants = d3.nest()
                .key(function(d) { return d["Funding Org:Name"]})
                .key(function(d) { return d["Recipient Org:Name"] })
                .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                .entries(filteredDataYear)

                var packableGrants = {key: "All Grants", values: nested_grants}

                var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                .sum(function(d) { return d.value })
                                .sort(function(a, b) { return b.value - a.value; })

                 var data_nodes = packLayout(rootNode).descendants()




                g.selectAll("circle")
                .data(data_nodes)
                .enter()
                .append("circle")
                .attr("r", function(d) {
                   return 0;
                 })
                .attr("cx", function(d) { return d.x })
                .attr("cy", function(d) { return  d.y })
                .style("fill", function(d) { return d.children ? colorCircle(d.depth) : "white"; })
                .style("opacity", 0)
                .transition()
                .duration(1000)
                .attr("r", function(d) { return d.r })
                .style("opacity", 1)




                g.selectAll(".text")
                  .data(data_nodes.filter(function(d) { return !!d.children }))
                  .enter()
                  .append("text")
                  .attr("x", function(d) { return d.x  })
                  .attr("y", function(d) { return d.y })
                  .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                  .text(function(d){ return d.data.key })
                  .style("fill", "none")
                  .attr("class", "labels_background")
                  .style("font-size", 15)
                  .style("stroke-width", 15*0.2)
                  .style("stroke", function(d) {
                    if(d.r < 30) return "none";
                    else return "#ffffff";
                  })
                  .attr("text-anchor", "middle")
                  .style("opacity", 0)
                  .transition()
                  .duration(1000)
                  .style("opacity", 1)


                g.selectAll(".labels")
                  .data(data_nodes.filter(function(d) { return !!d.children }))
                  .enter()
                  .append("text")
                  .attr("x", function(d) { return d.x })
                  .attr("y", function(d) { return d.y })
                  .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                  .text(function(d){ return d.data.key })
                  .style("fill", function(d) {
                    if(d.r < 30) return "none";
                    else return "black";
                  })
                  .attr("class", "labels_text")
                  .attr("text-anchor", "middle")
                  .style("font-size", 15)
                  .raise()
                  .style("opacity", 0)
                  .transition()
                  .duration(1000)
                  .style("opacity", 1);

                  g.append("text")
                            .attr("class", "slider_years")
                            .attr("x", w / 2)
                            .attr("y", 20)
                            .text(selectedYear)


            }

            d3.select("#menu")
              .on("input", function() {
                drawFilteredPack();
              })

        }) // Sports

/// HEALTH ////

d3.select("#health").on("click", function() {
  d3.selectAll("circle")
            .remove()
            d3.selectAll("text")
            .remove()
            d3.selectAll("line").remove()
            if(timer) {
           timer.stop()
          }
          document.getElementById("menu").value = 2004

          d3.select("#sports").style("background-color", "white").style("color", "black")
          d3.select("#health").style("background-color", "#52c2cb").style("color", "white")
          d3.select("#education").style("background-color", "white").style("color", "black")
          d3.select("#arts").style("background-color", "white").style("color", "black")
          d3.select("#transportation").style("background-color", "white").style("color", "black")
          d3.select("#environment").style("background-color", "white").style("color", "black")
          d3.select("#science").style("background-color", "white").style("color", "black")
          d3.select("#homelessness").style("background-color", "white").style("color", "black")
          d3.select("#veterans").style("background-color", "white").style("color", "black")

            function drawInitialPack(){
              years = d3.range(2004, 2019)

              var filter_data = data.filter(function(d) {
                return (d["Award Year"] == years[0]) && (d["Theme"] == "Health")
              })

              var nested_grants = d3.nest()
                .key(function(d) { return d["Funding Org:Name"]})
                .key(function(d) { return d["Recipient Org:Name"] })
                .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                .entries(filter_data)

                var packableGrants = {key: "All Grants", values: nested_grants}

                var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                .sum(function(d) { return d.value })
                                .sort(function(a, b) { return b.value - a.value; })

                  var sizeScale = d3.scaleSqrt()
                  .range([0.0001,0.01]);

                  packLayout.radius(d=>sizeScale(d.value));


                  var data_nodes = packLayout(rootNode).descendants()
                  pack.radius
                  g.selectAll("circle")
                  .data(data_nodes)
                  .enter()
                  .append("circle")
                  .attr("class", "circle_packs")
                  .attr("r", function(d) { return 0 })
                  .attr("cx", function(d) { return d.x })
                  .attr("cy", function(d) { return  d.y })
                  .style("fill", function(d) { return d.children ? colorCircleHealth(d.depth) : "white"; })
                  .transition()
                  .duration(1000)
                  .attr("r", function(d) { return d.r })


                  g.selectAll(".text")
                    .data(data_nodes.filter(function(d) { return !!d.children }))
                    .enter()
                    .append("text")
                    .attr("x", function(d) { return d.x })
                    .attr("y", function(d) { return d.y })
                    .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                    .text(function(d){ return d.data.key })
                    .style("fill", "none")
                    .attr("text-anchor", "middle")
                    .style("font-size", 15)
                    .attr("class", "labels_background")
                    .style("stroke-width", 15*0.2)
                    .style("stroke", function(d) {
                      if(d.r < 30) return "none";
                      else return "#ffffff";
                    })
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)

                    g.append("text")
                    .attr("class", "years")
                    .attr("x", w / 2)
                    .attr("y", 20)
                    .text(years[0])


                  g.selectAll(".labels")
                    .data(data_nodes.filter(function(d) { return !!d.children }))
                    .enter()
                    .append("text")
                    .attr("x", function(d) { return d.x })
                    .attr("y", function(d) { return d.y })
                    .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                    .text(function(d){ return d.data.key })
                    .style("fill", function(d) {
                      if(d.r < 30) return "none";
                      else return "black";
                    })
                    .attr("class", "labels_text")
                    .attr("text-anchor", "middle")
                    .style("font-size", 15)
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)

                    /// button play


            } // drawInitialPack

            drawInitialPack();

            var playButton = d3.select("#action")

            playButton.on("click", function() {
              var button = d3.select(this)
              d3.selectAll("line").remove()

                if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }
               timer = d3.interval(transitionSports, 4000)


                function transitionSports() {
                   var new_filtered_data = data.filter(function(d) {
                         return (d["Award Year"] == years[counter]) && (d["Theme"] == "Health")
                        })


                  var something = document.getElementById("menu").value = years[counter]


                  var new_nested_grants = d3.nest()
                    .key(function(d) { return d["Funding Org:Name"]})
                    .key(function(d) { return d["Recipient Org:Name"] })
                    .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                    .entries(new_filtered_data)

                    var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                    var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                    .sum(function(d) { return d.value })
                                    .sort(function(a, b) { return b.value - a.value; })

                      var new_data_nodes = packLayout(newRootNode).descendants()

                    var circle = g.selectAll("circle")
                       .data(new_data_nodes)

                     var text_background = g.selectAll(".text")
                         .data(new_data_nodes.filter(function(d) { return !!d.children }))

                     var text = g.selectAll(".labels")
                         .data(new_data_nodes.filter(function(d) { return !!d.children }))

                          if(g.select(".years")._groups[0][0]) {
                            g.select(".years")
                              .attr("x", w / 2)
                              .attr("y", 20)
                              .text(years[counter])
                          }
                          else {
                            g.append("text")
                              .attr("class", "years")
                              .attr("x", w / 2)
                              .attr("y", 20)
                              .text(years[counter])
                          }


                          if (years[counter] == 2016) {
                        g.append("text")
                              .attr("x",  0)
                              .attr("y", 50)
                              .text("The second most amount in awarded grants for a theme was in 2016 for Health")
                              .style("font-size", 15)
                              .style("opacity", 0)
                              .transition()
                              .duration(2000)
                              .style("opacity", 1)

                          g.append("text")
                              .attr("x",  0)
                              .attr("y", 70)
                              .text(" with $3,181,348,824 awarded. The most was in 2012 for the Transportation theme.")
                              .style("font-size", 15)
                              .style("opacity", 0)
                              .transition()
                              .duration(2000)
                              .style("opacity", 1)
                      }

                  var circleTransition =  d3.transition()
                       .duration(1000)

                   var textTransition = d3.transition()
                       .duration(1000)

                   // exit
                   circle.exit()
                       .style("fill", function(d) { return d.children ? colorCircleHealth(d.depth) : "white"; })
                       .transition(circleTransition)
                       .attr("r", function(d) { return 0 })
                       .remove()

                     d3.selectAll(".labels_text")
                     .remove();

                     d3.selectAll(".labels_background")
                     .remove();

                     d3.selectAll(".slider_years")
                     .remove()

                     // d3.selectAll(".years")
                     // .remove()

                   // update
                   circle.transition(circleTransition)
                       .style("fill", function(d) { return d.children ? colorCircleHealth(d.depth) : "white"; })
                       .attr("class", "circle_packs")
                       .attr("r", function(d) { return d.r })
                       .attr("cx", function(d) { return d.x })
                       .attr("cy", function(d) { return  d.y })
                       .style("opacity", 1)

                   text_background.transition(textTransition)
                       .attr("x", function(d){ return d.x; })
                       .attr("y", function(d){ return d.y; });

                     text.transition(textTransition)
                       .attr("x", function(d){ return d.x; })
                       .attr("y", function(d){ return d.y; });

                     //enter
                     circle.enter()
                     .append("circle")
                     .attr("r", function(d) { return 0 })
                     .attr("cx", function(d) { return d.x })
                     .attr("cy", function(d) { return  d.y })
                     .style("fill", function(d) { return d.children ? colorCircleHealth(d.depth) : "white"; })
                     .transition(circleTransition)
                     .attr("r", function(d) { return d.r })
                     .style("fill", function(d) { return d.children ? colorCircleHealth(d.depth) : "white"; })

                     text_background.enter()
                       .append("text")
                       .attr("opacity", 0)
                       .attr("class", "labels_background")
                       .attr("x", function(d) { return d.x })
                       .attr("y", function(d) { return d.y })
                       .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                       .text(function(d){ return d.data.key })
                       .style("fill", "none")
                       .style("font-size", 15)
                       .style("stroke-width", 15*0.2)
                       .style("stroke", function(d) {
                         if(d.r < 30) return "none";
                         else return "#ffffff";
                       })
                       .attr("text-anchor", "middle")
                       .transition(textTransition)
                       .style("opacity", 1)

                       text.enter()
                         .append("text")
                         .attr("opacity", 0)
                         .attr("class", "labels_text")
                         .attr("x", function(d) { return d.x })
                         .attr("y", function(d) { return d.y })
                         .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                         .text(function(d){ return d.data.key })
                         .style("fill", function(d) {
                           if(d.r < 30) return "none";
                           else return "black";
                         })
                         .attr("text-anchor", "middle")
                         .style("font-size", 15)
                         .transition(textTransition)
                         .style("opacity", 1)

                       counter += 1
                       if (counter === years.length) {
                        timer.stop()
                       }
               }// transition

                d3.select("#action")
                .on("click", function() {
                  timer.stop()
                })

            }) // action



              function drawFilteredPack(){
                d3.selectAll("circle")
                .remove()
                d3.selectAll("line").remove()

                d3.selectAll("text")
                .remove()

                if(timer == undefined) {
                }
                else {
                  timer.stop()
                }

                var selectedYear = document.getElementById("menu").value;

                var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Health") })

                var nested_grants = d3.nest()
                  .key(function(d) { return d["Funding Org:Name"]})
                  .key(function(d) { return d["Recipient Org:Name"] })
                  .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                  .entries(filteredDataYear)

                  var packableGrants = {key: "All Grants", values: nested_grants}

                  var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                  .sum(function(d) { return d.value })
                                  .sort(function(a, b) { return b.value - a.value; })

                   var data_nodes = packLayout(rootNode).descendants()




                  g.selectAll("circle")
                  .data(data_nodes)
                  .enter()
                  .append("circle")
                  .attr("r", function(d) {
                     return 0;
                   })
                  .attr("cx", function(d) { return d.x })
                  .attr("cy", function(d) { return  d.y })
                  .style("fill", function(d) { return d.children ? colorCircleHealth(d.depth) : "white"; })
                  .style("opacity", 0)
                  .transition()
                  .duration(1000)
                  .attr("r", function(d) { return d.r })
                  .style("opacity", 1)




                  g.selectAll(".text")
                    .data(data_nodes.filter(function(d) { return !!d.children }))
                    .enter()
                    .append("text")
                    .attr("x", function(d) { return d.x  })
                    .attr("y", function(d) { return d.y })
                    .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                    .text(function(d){ return d.data.key })
                    .style("fill", "none")
                    .attr("class", "labels_background")
                    .style("font-size", 15)
                    .style("stroke-width", 15*0.2)
                    .style("stroke", function(d) {
                      if(d.r < 30) return "none";
                      else return "#ffffff";
                    })
                    .attr("text-anchor", "middle")
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)


                  g.selectAll(".labels")
                    .data(data_nodes.filter(function(d) { return !!d.children }))
                    .enter()
                    .append("text")
                    .attr("x", function(d) { return d.x })
                    .attr("y", function(d) { return d.y })
                    .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                    .text(function(d){ return d.data.key })
                    .style("fill", function(d) {
                      if(d.r < 30) return "none";
                      else return "black";
                    })
                    .attr("class", "labels_text")
                    .attr("text-anchor", "middle")
                    .style("font-size", 15)
                    .raise()
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1);

                    g.append("text")
                              .attr("class", "slider_years")
                              .attr("x", w / 2)
                              .attr("y", 20)
                              .text(selectedYear)




              }

              d3.select("#menu")
                .on("input", function() {
                  drawFilteredPack();
                })

}) // Health


// EDUCATION


d3.select("#education").on("click", function() {
  d3.selectAll("circle")
            .remove()
            d3.selectAll("text")
            .remove()
            d3.selectAll("line").remove()
            if(timer) {
           timer.stop()
          }

          document.getElementById("menu").value = 2004

          d3.select("#sports").style("background-color", "white").style("color", "black")
          d3.select("#health").style("background-color", "white").style("color", "black")
          d3.select("#education").style("background-color", "#9b9f83").style("color", "white")
          d3.select("#arts").style("background-color", "white").style("color", "black")
          d3.select("#transportation").style("background-color", "white").style("color", "black")
          d3.select("#environment").style("background-color", "white").style("color", "black")
          d3.select("#science").style("background-color", "white").style("color", "black")
          d3.select("#homelessness").style("background-color", "white").style("color", "black")
          d3.select("#veterans").style("background-color", "white").style("color", "black")

            function drawInitialPack(){
              years = d3.range(2004, 2019)

              var filter_data = data.filter(function(d) {
                return (d["Award Year"] == years[0]) && (d["Theme"] == "Education")
              })

              var nested_grants = d3.nest()
                .key(function(d) { return d["Funding Org:Name"]})
                .key(function(d) { return d["Recipient Org:Name"] })
                .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                .entries(filter_data)

                var packableGrants = {key: "All Grants", values: nested_grants}

                var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                .sum(function(d) { return d.value })
                                .sort(function(a, b) { return b.value - a.value; })

                  var sizeScale = d3.scaleSqrt()
                  .range([0.0001,0.01]);

                  packLayout.radius(d=>sizeScale(d.value));


                  var data_nodes = packLayout(rootNode).descendants()
                  pack.radius
                  g.selectAll("circle")
                  .data(data_nodes)
                  .enter()
                  .append("circle")
                  .attr("class", "circle_packs")
                  .attr("r", function(d) { return 0 })
                  .attr("cx", function(d) { return d.x })
                  .attr("cy", function(d) { return  d.y })
                  .style("fill", function(d) { return d.children ? colorCircleEducation(d.depth) : "white"; })
                  .transition()
                  .duration(1000)
                  .attr("r", function(d) { return d.r })

                  g.selectAll(".text")
                    .data(data_nodes.filter(function(d) { return !!d.children }))
                    .enter()
                    .append("text")
                    .attr("x", function(d) { return d.x })
                    .attr("y", function(d) { return d.y })
                    .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                    .text(function(d){ return d.data.key })
                    .style("fill", "none")
                    .attr("text-anchor", "middle")
                    .style("font-size", 15)
                    .attr("class", "labels_background")
                    .style("stroke-width", 15*0.2)
                    .style("stroke", function(d) {
                      if(d.r < 30) return "none";
                      else return "#ffffff";
                    })
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)

                    g.append("text")
                    .attr("class", "years")
                    .attr("x", w / 2)
                    .attr("y", 20)
                    .text(years[0])


                  g.selectAll(".labels")
                    .data(data_nodes.filter(function(d) { return !!d.children }))
                    .enter()
                    .append("text")
                    .attr("x", function(d) { return d.x })
                    .attr("y", function(d) { return d.y })
                    .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                    .text(function(d){ return d.data.key })
                    .style("fill", function(d) {
                      if(d.r < 30) return "none";
                      else return "black";
                    })
                    .attr("class", "labels_text")
                    .attr("text-anchor", "middle")
                    .style("font-size", 15)
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)

                    /// button play


            } // drawInitialPack

            drawInitialPack();

            var playButton = d3.select("#action")

            playButton.on("click", function() {
              var button = d3.select(this)

                if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }
               timer = d3.interval(transitionSports, 4000)

                function transitionSports() {
                  d3.selectAll("line").remove()
                   var new_filtered_data = data.filter(function(d) {
                         return (d["Award Year"] == years[counter]) && (d["Theme"] == "Education")
                        })

                  var something = document.getElementById("menu").value = years[counter]


                  var new_nested_grants = d3.nest()
                    .key(function(d) { return d["Funding Org:Name"]})
                    .key(function(d) { return d["Recipient Org:Name"] })
                    .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                    .entries(new_filtered_data)

                    var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                    var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                    .sum(function(d) { return d.value })
                                    .sort(function(a, b) { return b.value - a.value; })

                      var new_data_nodes = packLayout(newRootNode).descendants()

                    var circle = g.selectAll("circle")
                       .data(new_data_nodes)

                     var text_background = g.selectAll(".text")
                         .data(new_data_nodes.filter(function(d) { return !!d.children }))

                     var text = g.selectAll(".labels")
                         .data(new_data_nodes.filter(function(d) { return !!d.children }))

                          if(g.select(".years")._groups[0][0]) {
                            g.select(".years")
                              .attr("x", w / 2)
                              .attr("y", 20)
                              .text(years[counter])
                          }
                          else {
                            g.append("text")
                              .attr("class", "years")
                              .attr("x", w / 2)
                              .attr("y", 20)
                              .text(years[counter])
                          }

                  var circleTransition =  d3.transition()
                       .duration(1000)

                   var textTransition = d3.transition()
                       .duration(1000)

                   // exit
                   circle.exit()
                       .style("fill", function(d) { return d.children ? colorCircleEducation(d.depth) : "white"; })
                       .transition(circleTransition)
                       .attr("r", function(d) { return 0 })
                       .remove()

                     d3.selectAll(".labels_text")
                     .remove();

                     d3.selectAll(".labels_background")
                     .remove();

                     d3.selectAll(".slider_years")
                     .remove()

                     // d3.selectAll(".years")
                     // .remove()

                   // update
                   circle.transition(circleTransition)
                       .style("fill", function(d) { return d.children ? colorCircleEducation(d.depth) : "white"; })
                       .attr("class", "circle_packs")
                       .attr("r", function(d) { return d.r })
                       .attr("cx", function(d) { return d.x })
                       .attr("cy", function(d) { return  d.y })
                       .style("opacity", 1)

                   text_background.transition(textTransition)
                       .attr("x", function(d){ return d.x; })
                       .attr("y", function(d){ return d.y; });

                     text.transition(textTransition)
                       .attr("x", function(d){ return d.x; })
                       .attr("y", function(d){ return d.y; });

                     //enter
                     circle.enter()
                     .append("circle")
                     .attr("r", function(d) { return 0 })
                     .attr("cx", function(d) { return d.x })
                     .attr("cy", function(d) { return  d.y })
                     .style("fill", function(d) { return d.children ? colorCircleEducation(d.depth) : "white"; })
                     .transition(circleTransition)
                     .attr("r", function(d) { return d.r })
                     .style("fill", function(d) { return d.children ? colorCircleEducation(d.depth) : "white"; })

                     text_background.enter()
                       .append("text")
                       .attr("opacity", 0)
                       .attr("class", "labels_background")
                       .attr("x", function(d) { return d.x })
                       .attr("y", function(d) { return d.y })
                       .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                       .text(function(d){ return d.data.key })
                       .style("fill", "none")
                       .style("font-size", 15)
                       .style("stroke-width", 15*0.2)
                       .style("stroke", function(d) {
                         if(d.r < 30) return "none";
                         else return "#ffffff";
                       })
                       .attr("text-anchor", "middle")
                       .transition(textTransition)
                       .style("opacity", function(d) {
                            if(years[counter] == 2015){
                              if(d.data.key == "Paul Hamlyn Foundation") return 0;
                              else return 1
                            }
                          else {
                            return 1;
                          }
                       })

                       text.enter()
                         .append("text")
                         .attr("opacity", 0)
                         .attr("class", "labels_text")
                         .attr("x", function(d) { return d.x })
                         .attr("y", function(d) { return d.y })
                         .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                         .text(function(d){ return d.data.key })
                         .style("fill", function(d) {
                           if(d.r < 30) return "none";
                           else return "black";
                         })
                         .attr("text-anchor", "middle")
                         .style("font-size", 15)
                         .transition(textTransition)
                         .style("opacity", function(d) {
                              if(years[counter] == 2015){
                                if(d.data.key == "Paul Hamlyn Foundation") return 0;
                                else return 1
                              }
                            else {
                              return 1;
                            }
                         })


                       counter += 1
                       if (counter === years.length) {
                        timer.stop()
                       }
               }// transition

                d3.select("#action")
                .on("click", function() {
                  timer.stop()
                })

            }) // action



              function drawFilteredPack(){
                d3.selectAll("line").remove()
                d3.selectAll("circle")
                .remove()

                d3.selectAll("text")
                .remove()

                if(timer == undefined) {
                }
                else {
                  timer.stop()
                }

                var selectedYear = document.getElementById("menu").value;

                var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Education") })

                var nested_grants = d3.nest()
                  .key(function(d) { return d["Funding Org:Name"]})
                  .key(function(d) { return d["Recipient Org:Name"] })
                  .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                  .entries(filteredDataYear)

                  var packableGrants = {key: "All Grants", values: nested_grants}

                  var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                  .sum(function(d) { return d.value })
                                  .sort(function(a, b) { return b.value - a.value; })

                   var data_nodes = packLayout(rootNode).descendants()




                  g.selectAll("circle")
                  .data(data_nodes)
                  .enter()
                  .append("circle")
                  .attr("r", function(d) {
                     return 0;
                   })
                  .attr("cx", function(d) { return d.x })
                  .attr("cy", function(d) { return  d.y })
                  .style("fill", function(d) { return d.children ? colorCircleEducation(d.depth) : "white"; })
                  .style("opacity", 0)
                  .transition()
                  .duration(1000)
                  .attr("r", function(d) { return d.r })
                  .style("opacity", 1)




                  g.selectAll(".text")
                    .data(data_nodes.filter(function(d) { return !!d.children }))
                    .enter()
                    .append("text")
                    .attr("x", function(d) { return d.x  })
                    .attr("y", function(d) { return d.y })
                    .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                    .text(function(d){ return d.data.key })
                    .style("fill", "none")
                    .attr("class", "labels_background")
                    .style("font-size", 15)
                    .style("stroke-width", 15*0.2)
                    .style("stroke", function(d) {
                      if(d.r < 30) return "none";
                      else return "#ffffff";
                    })
                    .attr("text-anchor", "middle")
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", function(d) {
                         if(selectedYear == 2015){
                           if(d.data.key == "Paul Hamlyn Foundation") return 0;
                           else return 1
                         }
                       else {
                         return 1;
                       }
                    })

                  g.selectAll(".labels")
                    .data(data_nodes.filter(function(d) { return !!d.children }))
                    .enter()
                    .append("text")
                    .attr("x", function(d) { return d.x })
                    .attr("y", function(d) { return d.y })
                    .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                    .text(function(d){ return d.data.key })
                    .style("fill", function(d) {
                      if(d.r < 30) return "none";
                      else return "black";
                    })
                    .attr("class", "labels_text")
                    .attr("text-anchor", "middle")
                    .style("font-size", 15)
                    .raise()
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", function(d) {
                      if(selectedYear == 2015){
                        if(d.data.key == "Paul Hamlyn Foundation") return 0;
                        else return 1
                      }
                    else {
                      return 1;
                    }
                 })


                    g.append("text")
                          .attr("class", "slider_years")
                          .attr("x", w / 2)
                          .attr("y", 20)
                          .text(selectedYear)

              }

              d3.select("#menu")
                .on("input", function() {
                  drawFilteredPack();
                })

}) // education

// ARTS

  d3.select("#arts").on("click", function() {
    d3.selectAll("circle")
              .remove()
              d3.selectAll("text")
              .remove()
              d3.selectAll("line").remove()
              if(timer) {
             timer.stop()
            }

            document.getElementById("menu").value = 2004

            d3.select("#sports").style("background-color", "white").style("color", "black")
            d3.select("#health").style("background-color", "white").style("color", "black")
            d3.select("#education").style("background-color", "white").style("color", "black")
            d3.select("#arts").style("background-color", "grey").style("color", "white")
            d3.select("#transportation").style("background-color", "white").style("color", "black")
            d3.select("#environment").style("background-color", "white").style("color", "black")
            d3.select("#science").style("background-color", "white").style("color", "black")
            d3.select("#homelessness").style("background-color", "white").style("color", "black")
            d3.select("#veterans").style("background-color", "white").style("color", "black")

              function drawInitialPack(){
                years = d3.range(2004, 2019)

                var filter_data = data.filter(function(d) {
                  return (d["Award Year"] == years[0]) && (d["Theme"] == "Arts")
                })

                var nested_grants = d3.nest()
                  .key(function(d) { return d["Funding Org:Name"]})
                  .key(function(d) { return d["Recipient Org:Name"] })
                  .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                  .entries(filter_data)

                  var packableGrants = {key: "All Grants", values: nested_grants}

                  var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                  .sum(function(d) { return d.value })
                                  .sort(function(a, b) { return b.value - a.value; })

                    var sizeScale = d3.scaleSqrt()
                    .range([0.0001,0.01]);

                    packLayout.radius(d=>sizeScale(d.value));


                    var data_nodes = packLayout(rootNode).descendants()
                    pack.radius
                    g.selectAll("circle")
                    .data(data_nodes)
                    .enter()
                    .append("circle")
                    .attr("class", "circle_packs")
                    .attr("r", function(d) { return 0 })
                    .attr("cx", function(d) { return d.x })
                    .attr("cy", function(d) { return  d.y })
                    .style("fill", function(d) { return d.children ? colorCircleArts(d.depth) : "white"; })
                    .transition()
                    .duration(1000)
                    .attr("r", function(d) { return d.r })


                    g.selectAll(".text")
                      .data(data_nodes.filter(function(d) { return !!d.children }))
                      .enter()
                      .append("text")
                      .attr("x", function(d) { return d.x })
                      .attr("y", function(d) { return d.y })
                      .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                      .text(function(d){ return d.data.key })
                      .style("fill", "none")
                      .attr("text-anchor", "middle")
                      .style("font-size", 15)
                      .attr("class", "labels_background")
                      .style("stroke-width", 15*0.2)
                      .style("stroke", function(d) {
                        if(d.r < 30) return "none";
                        else return "#ffffff";
                      })
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .style("opacity", 1)

                      g.append("text")
                      .attr("class", "years")
                      .attr("x", w / 2)
                      .attr("y", 20)
                      .text(years[0])


                    g.selectAll(".labels")
                      .data(data_nodes.filter(function(d) { return !!d.children }))
                      .enter()
                      .append("text")
                      .attr("x", function(d) { return d.x })
                      .attr("y", function(d) { return d.y })
                      .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                      .text(function(d){ return d.data.key })
                      .style("fill", function(d) {
                        if(d.r < 30) return "none";
                        else return "black";
                      })
                      .attr("class", "labels_text")
                      .attr("text-anchor", "middle")
                      .style("font-size", 15)
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .style("opacity", 1)

                      /// button play


              } // drawInitialPack

              drawInitialPack();

              var playButton = d3.select("#action")

              playButton.on("click", function() {
                var button = d3.select(this)

                  if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }
                 timer = d3.interval(transitionSports, 4000)

                  function transitionSports() {
                    d3.selectAll("line").remove()
                     var new_filtered_data = data.filter(function(d) {
                           return (d["Award Year"] == years[counter]) && (d["Theme"] == "Arts")
                          })

                    var something = document.getElementById("menu").value = years[counter]



                    var new_nested_grants = d3.nest()
                      .key(function(d) { return d["Funding Org:Name"]})
                      .key(function(d) { return d["Recipient Org:Name"] })
                      .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                      .entries(new_filtered_data)

                      var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                      var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                      .sum(function(d) { return d.value })
                                      .sort(function(a, b) { return b.value - a.value; })

                        var new_data_nodes = packLayout(newRootNode).descendants()

                      var circle = g.selectAll("circle")
                         .data(new_data_nodes)

                       var text_background = g.selectAll(".text")
                           .data(new_data_nodes.filter(function(d) { return !!d.children }))

                       var text = g.selectAll(".labels")
                           .data(new_data_nodes.filter(function(d) { return !!d.children }))

                            if(g.select(".years")._groups[0][0]) {
                              g.select(".years")
                                .attr("x", w / 2)
                                .attr("y", 20)
                                .text(years[counter])
                            }
                            else {
                              g.append("text")
                                .attr("class", "years")
                                .attr("x", w / 2)
                                .attr("y", 20)
                                .text(years[counter])
                            }

                    var circleTransition =  d3.transition()
                         .duration(1000)

                     var textTransition = d3.transition()
                         .duration(1000)

                     // exit
                     circle.exit()
                         .style("fill", function(d) { return d.children ? colorCircleArts(d.depth) : "white"; })
                         .transition(circleTransition)
                         .attr("r", function(d) { return 0 })
                         .remove()

                       d3.selectAll(".labels_text")
                       .remove();

                       d3.selectAll(".labels_background")
                       .remove();

                       d3.selectAll(".slider_years")
                       .remove()

                       // d3.selectAll(".years")
                       // .remove()

                     // update
                     circle.transition(circleTransition)
                         .style("fill", function(d) { return d.children ? colorCircleArts(d.depth) : "white"; })
                         .attr("class", "circle_packs")
                         .attr("r", function(d) { return d.r })
                         .attr("cx", function(d) { return d.x })
                         .attr("cy", function(d) { return  d.y })
                         .style("opacity", 1)

                     text_background.transition(textTransition)
                         .attr("x", function(d){ return d.x; })
                         .attr("y", function(d){ return d.y; });

                       text.transition(textTransition)
                         .attr("x", function(d){ return d.x; })
                         .attr("y", function(d){ return d.y; });

                       //enter
                       circle.enter()
                       .append("circle")
                       .attr("r", function(d) { return 0 })
                       .attr("cx", function(d) { return d.x })
                       .attr("cy", function(d) { return  d.y })
                       .style("fill", function(d) { return d.children ? colorCircleArts(d.depth) : "white"; })
                       .transition(circleTransition)
                       .attr("r", function(d) { return d.r })
                       .style("fill", function(d) { return d.children ? colorCircleArts(d.depth) : "white"; })

                       text_background.enter()
                         .append("text")
                         .attr("opacity", 0)
                         .attr("class", "labels_background")
                         .attr("x", function(d) {
                            if(years[counter] == 2010 || years[counter] == 2011){
                              if(d.data.key == "The Wellcome Trust") return d.x - 10;
                              else return d.x;
                            }
                            else if (years[counter] == 2017 || years[counter] == 2015){
                              if(d.data.key == "The Wellcome Trust") return d.x + 20;
                              else return d.x;
                            }
                            else if (years[counter] == 2014){
                              if(d.data.key == "The Wellcome Trust") return d.x - 50;
                              else return d.x;
                            }
                            else{
                              return d.x
                            }

                          })
                         .attr("y", function(d) { return d.y })
                         .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                         .text(function(d){ return d.data.key })
                         .style("fill", "none")
                         .style("font-size", 15)
                         .style("stroke-width", 15*0.2)
                         .style("stroke", function(d) {
                           if(d.r < 30) return "none";
                           else return "#ffffff";
                         })
                         .attr("text-anchor", "middle")
                         .transition(textTransition)
                         .style("opacity", 1)

                         text.enter()
                           .append("text")
                           .attr("opacity", 0)
                           .attr("class", "labels_text")
                           .attr("x", function(d) {
                            if(years[counter] == 2010 || years[counter] == 2011){
                              if(d.data.key == "The Wellcome Trust") return d.x - 10;
                              else return d.x;
                            }
                            else if (years[counter] == 2017 || years[counter] == 2015){
                              if(d.data.key == "The Wellcome Trust") return d.x + 20;
                              else return d.x;
                            }
                            else if (years[counter] == 2014){
                              if(d.data.key == "The Wellcome Trust") return d.x - 50;
                              else return d.x;
                            }
                            else{
                              return d.x
                            }

                          })
                           .attr("y", function(d) { return d.y })
                           .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                           .text(function(d){ return d.data.key })
                           .style("fill", function(d) {
                             if(d.r < 30) return "none";
                             else return "black";
                           })
                           .attr("text-anchor", "middle")
                           .style("font-size", 15)
                           .transition(textTransition)
                           .style("opacity", 1)

                         counter += 1
                         if (counter === years.length) {
                          timer.stop()
                         }
                 }// transition

                  d3.select("#action")
                  .on("click", function() {
                    timer.stop()
                  })

              }) // action



                function drawFilteredPack(){
                  d3.selectAll("line").remove()
                  d3.selectAll("circle")
                  .remove()

                  d3.selectAll("text")
                  .remove()

                  if(timer == undefined) {
                  }
                  else {
                    timer.stop()
                  }

                  var selectedYear = document.getElementById("menu").value;

                  var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Arts") })

                  var nested_grants = d3.nest()
                    .key(function(d) { return d["Funding Org:Name"]})
                    .key(function(d) { return d["Recipient Org:Name"] })
                    .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                    .entries(filteredDataYear)

                    var packableGrants = {key: "All Grants", values: nested_grants}

                    var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                    .sum(function(d) { return d.value })
                                    .sort(function(a, b) { return b.value - a.value; })

                     var data_nodes = packLayout(rootNode).descendants()

                    g.selectAll("circle")
                    .data(data_nodes)
                    .enter()
                    .append("circle")
                    .attr("r", function(d) {
                       return 0;
                     })
                    .attr("cx", function(d) { return d.x })
                    .attr("cy", function(d) { return  d.y })
                    .style("fill", function(d) { return d.children ? colorCircleArts(d.depth) : "white"; })
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .attr("r", function(d) { return d.r })
                    .style("opacity", 1)

                    g.selectAll(".text")
                      .data(data_nodes.filter(function(d) { return !!d.children }))
                      .enter()
                      .append("text")
                      .attr("x", function(d) {
                        if(selectedYear == 2010 || selectedYear == 2011){
                          if(d.data.key == "The Wellcome Trust") return d.x - 10;
                          else return d.x;
                        }
                        else if (selectedYear == 2017 || selectedYear == 2015){
                          if(d.data.key == "The Wellcome Trust") return d.x + 20;
                          else return d.x;
                        }
                        else if (selectedYear == 2014){
                          if(d.data.key == "The Wellcome Trust") return d.x - 50;
                          else return d.x;
                        }
                        else{
                          return d.x
                        }

                      })
                      .attr("y", function(d) { return d.y })
                      .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                      .text(function(d){ return d.data.key })
                      .style("fill", "none")
                      .attr("class", "labels_background")
                      .style("font-size", 15)
                      .style("stroke-width", 15*0.2)
                      .style("stroke", function(d) {
                        if(d.r < 30) return "none";
                        else return "#ffffff";
                      })
                      .attr("text-anchor", "middle")
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .style("opacity", 1)


                    g.selectAll(".labels")
                      .data(data_nodes.filter(function(d) { return !!d.children }))
                      .enter()
                      .append("text")
                      .attr("x", function(d) {
                        if(selectedYear == 2010 || selectedYear == 2011){
                          if(d.data.key == "The Wellcome Trust") return d.x - 10;
                          else return d.x;
                        }
                        else if (selectedYear == 2017 || selectedYear == 2015){
                          if(d.data.key == "The Wellcome Trust") return d.x + 20;
                          else return d.x;
                        }
                        else if (selectedYear == 2014){
                          if(d.data.key == "The Wellcome Trust") return d.x - 50;
                          else return d.x;
                        }
                        else{
                          return d.x
                        }

                      })
                      .attr("y", function(d) { return d.y })
                      .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                      .text(function(d){ return d.data.key })
                      .style("fill", function(d) {
                        if(d.r < 30) return "none";
                        else return "black";
                      })
                      .attr("class", "labels_text")
                      .attr("text-anchor", "middle")
                      .style("font-size", 15)
                      .raise()
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .style("opacity", 1);


                      g.append("text")
                                .attr("class", "slider_years")
                                .attr("x", w / 2)
                                .attr("y", 20)
                                .text(selectedYear)


                }

                d3.select("#menu")
                  .on("input", function() {
                    drawFilteredPack();
                  })

  }) // arts

  // Transportation

    d3.select("#transportation").on("click", function() {
      d3.selectAll("circle")
                .remove()
                d3.selectAll("text")
                .remove()
                d3.selectAll("line").remove()
                if(timer) {
               timer.stop()
              }

              document.getElementById("menu").value = 2004
                function drawInitialPack(){
                  d3.selectAll("line").remove()
                  years = d3.range(2004, 2019)

                  var filter_data = data.filter(function(d) {
                    return (d["Award Year"] == years[0]) && (d["Theme"] == "Transportation")
                  })

                  d3.select("#sports").style("background-color", "white").style("color", "black")
                  d3.select("#health").style("background-color", "white").style("color", "black")
                  d3.select("#education").style("background-color", "white").style("color", "black")
                  d3.select("#arts").style("background-color", "white").style("color", "black")
                  d3.select("#transportation").style("background-color", "#996633").style("color", "white")
                  d3.select("#environment").style("background-color", "white").style("color", "black")
                  d3.select("#science").style("background-color", "white").style("color", "black")
                  d3.select("#homelessness").style("background-color", "white").style("color", "black")
                  d3.select("#veterans").style("background-color", "white").style("color", "black")

                  var nested_grants = d3.nest()
                    .key(function(d) { return d["Funding Org:Name"]})
                    .key(function(d) { return d["Recipient Org:Name"] })
                    .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                    .entries(filter_data)

                    var packableGrants = {key: "All Grants", values: nested_grants}

                    var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                    .sum(function(d) { return d.value })
                                    .sort(function(a, b) { return b.value - a.value; })

                      var sizeScale = d3.scaleSqrt()
                      .range([0.0001,0.01]);

                      packLayout.radius(d=>sizeScale(d.value));


                      var data_nodes = packLayout(rootNode).descendants()

                      g.selectAll("circle")
                      .data(data_nodes)
                      .enter()
                      .append("circle")
                      .attr("class", "circle_packs")
                      .attr("r", function(d) { return 0 })
                      .attr("cx", function(d) { return d.x })
                      .attr("cy", function(d) { return  d.y })
                      .style("fill", function(d) { return d.children ? colorCircleTransportation(d.depth) : "white"; })
                      .transition()
                      .duration(1000)
                      .attr("r", function(d) { return d.r })

                      g.selectAll(".text")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", "none")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .attr("class", "labels_background")
                        .style("stroke-width", 15*0.2)
                        .style("stroke", function(d) {
                          if(d.r < 30) return "none";
                          else return "#ffffff";
                        })
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)

                        g.append("text")
                        .attr("class", "years")
                        .attr("x", w / 2)
                        .attr("y", 20)
                        .text(years[0])


                      g.selectAll(".labels")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", function(d) {
                          if(d.r < 30) return "none";
                          else return "black";
                        })
                        .attr("class", "labels_text")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)


                        /// button play


                } // drawInitialPack

                drawInitialPack();

                var playButton = d3.select("#action")

                playButton.on("click", function() {
                  var button = d3.select(this)

                  if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }


                   timer = d3.interval(transitionSports, 4000)

                    function transitionSports() {
                      d3.selectAll("line").remove()
                       var new_filtered_data = data.filter(function(d) {
                             return (d["Award Year"] == years[counter]) && (d["Theme"] == "Transportation")
                            })

                      var something = document.getElementById("menu").value = years[counter]



                      var new_nested_grants = d3.nest()
                        .key(function(d) { return d["Funding Org:Name"]})
                        .key(function(d) { return d["Recipient Org:Name"] })
                        .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                        .entries(new_filtered_data)

                        var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                        var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                        .sum(function(d) { return d.value })
                                        .sort(function(a, b) { return b.value - a.value; })

                          var new_data_nodes = packLayout(newRootNode).descendants()

                        var circle = g.selectAll("circle")
                           .data(new_data_nodes)

                         var text_background = g.selectAll(".text")
                             .data(new_data_nodes.filter(function(d) { return !!d.children }))

                         var text = g.selectAll(".labels")
                             .data(new_data_nodes.filter(function(d) { return !!d.children }))

                              if(g.select(".years")._groups[0][0]) {
                                g.select(".years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(years[counter])
                              }
                              else {
                                g.append("text")
                                  .attr("class", "years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(years[counter])
                              }

                              if (years[counter] == 2013) {
                                g.append("text")
                                  .attr("x", 0)
                                  .attr("y", 60)
                                  .text("In 2012 the Department for Transport awarded $3,747,040,226 in grants to")
                                  .style("font-size", 15)
                                  .style("opacity", 0)
                                  .transition()
                                  .duration(2000)
                                  .style("opacity", 1)

                                g.append("text")
                                  .attr("x", 0)
                                  .attr("y", 80)
                                  .text(" transportation themed recipients. No other organization awarded that many")
                                  .style("font-size", 15)
                                  .style("opacity", 0)
                                  .transition()
                                  .duration(2000)
                                  .style("opacity", 1)

                                g.append("text")
                                  .attr("x", 0)
                                  .attr("y", 100)
                                  .text(" grants in a single year.")
                                  .style("font-size", 15)
                                  .style("opacity", 0)
                                  .transition()
                                  .duration(2000)
                                  .style("opacity", 1)
                              }

                      var circleTransition =  d3.transition()
                           .duration(1000)

                       var textTransition = d3.transition()
                           .duration(1000)

                       // exit
                       circle.exit()
                           .style("fill", function(d) { return d.children ? colorCircleTransportation(d.depth) : "white"; })
                           .transition(circleTransition)
                           .attr("r", function(d) { return 0 })
                           .remove()

                         d3.selectAll(".labels_text")
                         .remove();

                         d3.selectAll(".labels_background")
                         .remove();

                         d3.selectAll(".slider_years")
                         .remove()

                         // d3.selectAll(".years")
                         // .remove()

                       // update
                       circle.transition(circleTransition)
                           .style("fill", function(d) { return d.children ? colorCircleTransportation(d.depth) : "white"; })
                           .attr("class", "circle_packs")
                           .attr("r", function(d) { return d.r })
                           .attr("cx", function(d) { return d.x })
                           .attr("cy", function(d) { return  d.y })
                           .style("opacity", 1)

                       text_background.transition(textTransition)
                           .attr("x", function(d){ return d.x; })
                           .attr("y", function(d){ return d.y; });

                         text.transition(textTransition)
                           .attr("x", function(d){ return d.x; })
                           .attr("y", function(d){ return d.y; });

                         //enter
                         circle.enter()
                         .append("circle")
                         .attr("r", function(d) { return 0 })
                         .attr("cx", function(d) { return d.x })
                         .attr("cy", function(d) { return  d.y })
                         .style("fill", function(d) { return d.children ? colorCircleTransportation(d.depth) : "white"; })
                         .transition(circleTransition)
                         .attr("r", function(d) { return d.r })
                         .style("fill", function(d) { return d.children ? colorCircleTransportation(d.depth) : "white"; })

                         text_background.enter()
                           .append("text")
                           .attr("opacity", 0)
                           .attr("class", "labels_background")
                           .attr("x", function(d) { return d.x })
                           .attr("y", function(d) { return d.y })
                           .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                           .text(function(d){ return d.data.key })
                           .style("fill", "none")
                           .style("font-size", 15)
                           .style("stroke-width", 15*0.2)
                           .style("stroke", function(d) {
                             if(d.r < 30) return "none";
                             else return "#ffffff";
                           })
                           .attr("text-anchor", function(d){
                             if(years[counter] == 2011 || years[counter] == 2013){
                               if(d.data.key == "The Wellcome Trust") {
                                  return "start"
                               }
                               else if(d.data.key == "The Big Lottery Fund") {
                                 return "middle"
                               }
                             }
                             else{
                               if(d.data.key == "The Wellcome Trust") {
                                  return "middle"
                               }
                               else if(d.data.key == "The Big Lottery Fund") {
                                 return "start"
                               }
                             }
                           })
                           .transition(textTransition)
                           .style("opacity", 1)

                           text.enter()
                             .append("text")
                             .attr("opacity", 0)
                             .attr("class", "labels_text")
                             .attr("x", function(d) { return d.x })
                             .attr("y", function(d) { return d.y })
                             .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                             .text(function(d){ return d.data.key })
                             .style("fill", function(d) {
                               if(d.r < 30) return "none";
                               else return "black";
                             })
                             .attr("text-anchor", function(d){
                               if(years[counter] == 2011 || years[counter] == 2013){
                                 if(d.data.key == "The Wellcome Trust") {
                                    return "start"
                                 }
                                 else if(d.data.key == "The Big Lottery Fund") {
                                   return "middle"
                                 }
                               }
                               else{
                                 if(d.data.key == "The Wellcome Trust") {
                                    return "middle"
                                 }
                                 else if(d.data.key == "The Big Lottery Fund") {
                                   return "start"
                                 }
                               }
                             })
                             .style("font-size", 15)
                             .transition(textTransition)
                             .style("opacity", 1)

                           counter += 1
                           if (counter === years.length) {
                            timer.stop()
                           }
                   }// transition

                    d3.select("#action")
                    .on("click", function() {
                      timer.stop()
                    })

                }) // action



                  function drawFilteredPack(){
                    d3.selectAll("line").remove()
                    d3.selectAll("circle")
                    .remove()

                    d3.selectAll("text")
                    .remove()

                    if(timer == undefined) {
                    }
                    else {
                      timer.stop()
                    }

                    var selectedYear = document.getElementById("menu").value;

                    var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Transportation") })

                    var nested_grants = d3.nest()
                      .key(function(d) { return d["Funding Org:Name"]})
                      .key(function(d) { return d["Recipient Org:Name"] })
                      .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                      .entries(filteredDataYear)

                      var packableGrants = {key: "All Grants", values: nested_grants}

                      var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                      .sum(function(d) { return d.value })
                                      .sort(function(a, b) { return b.value - a.value; })

                       var data_nodes = packLayout(rootNode).descendants()




                      g.selectAll("circle")
                      .data(data_nodes)
                      .enter()
                      .append("circle")
                      .attr("r", function(d) {
                         return 0;
                       })
                      .attr("cx", function(d) { return d.x })
                      .attr("cy", function(d) {
                        return  d.y
                      })
                      .style("fill", function(d) { return d.children ? colorCircleTransportation(d.depth) : "white"; })
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .attr("r", function(d) { return d.r })
                      .style("opacity", 1)




                      g.selectAll(".text")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x  })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", "none")
                        .attr("class", "labels_background")
                        .style("font-size", 15)
                        .style("stroke-width", 15*0.2)
                        .style("stroke", function(d) {
                          if(d.r < 30) return "none";
                          else return "#ffffff";
                        })
                        .attr("text-anchor", function(d){
                          if(selectedYear == 2011 || selectedYear == 2013){
                            if(d.data.key == "The Wellcome Trust") {
                               return "start"
                            }
                            else if(d.data.key == "The Big Lottery Fund") {
                              return "middle"
                            }
                          }
                          else{
                            if(d.data.key == "The Wellcome Trust") {
                               return "middle"
                            }
                            else if(d.data.key == "The Big Lottery Fund") {
                              return "start"
                            }
                          }
                        })
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)


                      g.selectAll(".labels")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", function(d) {
                          if(d.r < 30) return "none";
                          else return "black";
                        })
                        .attr("class", "labels_text")
                        .attr("text-anchor", function(d){
                          if(selectedYear == 2011 || selectedYear == 2013){
                            if(d.data.key == "The Wellcome Trust") {
                               return "start"
                            }
                            else if(d.data.key == "The Big Lottery Fund") {
                              return "middle"
                            }
                          }
                          else{
                            if(d.data.key == "The Wellcome Trust") {
                               return "middle"
                            }
                            else if(d.data.key == "The Big Lottery Fund") {
                              return "start"
                            }
                          }
                        })
                        .style("font-size", 15)
                        .raise()
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1);

                        g.append("text")
                              .attr("class", "slider_years")
                              .attr("x", w / 2)
                              .attr("y", 20)
                              .text(selectedYear)




                  }

                  d3.select("#menu")
                    .on("input", function() {
                      drawFilteredPack();
                    })

    }) // transportation

// Environment

  d3.select("#environment").on("click", function() {
    d3.selectAll("circle")
              .remove()
              d3.selectAll("text")
              .remove()
              d3.selectAll("line").remove()
              if(timer) {
             timer.stop()
            }
            document.getElementById("menu").value = 2004
              function drawInitialPack(){
                years = d3.range(2004, 2019)

                var filter_data = data.filter(function(d) {
                  return (d["Award Year"] == years[0]) && (d["Theme"] == "Environment")
                })

                d3.select("#sports").style("background-color", "white").style("color", "black")
                d3.select("#health").style("background-color", "white").style("color", "black")
                d3.select("#education").style("background-color", "white").style("color", "black")
                d3.select("#arts").style("background-color", "white").style("color", "black")
                d3.select("#transportation").style("background-color", "white").style("color", "black")
                d3.select("#environment").style("background-color", "#178317").style("color", "white")
                d3.select("#science").style("background-color", "white").style("color", "black")
                d3.select("#homelessness").style("background-color", "white").style("color", "black")
                d3.select("#veterans").style("background-color", "white").style("color", "black")

                var nested_grants = d3.nest()
                  .key(function(d) { return d["Funding Org:Name"]})
                  .key(function(d) { return d["Recipient Org:Name"] })
                  .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                  .entries(filter_data)

                  var packableGrants = {key: "All Grants", values: nested_grants}

                  var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                  .sum(function(d) { return d.value })
                                  .sort(function(a, b) { return b.value - a.value; })

                    var sizeScale = d3.scaleSqrt()
                    .range([0.0001,0.01]);

                    packLayout.radius(d=>sizeScale(d.value));


                    var data_nodes = packLayout(rootNode).descendants()

                    g.selectAll("circle")
                    .data(data_nodes)
                    .enter()
                    .append("circle")
                    .attr("class", "circle_packs")
                    .attr("r", function(d) { return 0 })
                    .attr("cx", function(d) { return d.x })
                    .attr("cy", function(d) { return  d.y })
                    .style("fill", function(d) { return d.children ? colorCircleEnvironment(d.depth) : "white"; })
                    .transition()
                    .duration(1000)
                    .attr("r", function(d) { return d.r })



                    g.selectAll(".text")
                      .data(data_nodes.filter(function(d) { return !!d.children }))
                      .enter()
                      .append("text")
                      .attr("x", function(d) { return d.x })
                      .attr("y", function(d) { return d.y })
                      .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                      .text(function(d){ return d.data.key })
                      .style("fill", "none")
                      .attr("text-anchor", "middle")
                      .style("font-size", 15)
                      .attr("class", "labels_background")
                      .style("stroke-width", 15*0.2)
                      .style("stroke", function(d) {
                        if(d.r < 30) return "none";
                        else return "#ffffff";
                      })
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .style("opacity", 1)

                      g.append("text")
                      .attr("class", "years")
                      .attr("x", w / 2)
                      .attr("y", 20)
                      .text(years[0])


                    g.selectAll(".labels")
                      .data(data_nodes.filter(function(d) { return !!d.children }))
                      .enter()
                      .append("text")
                      .attr("x", function(d) { return d.x })
                      .attr("y", function(d) { return d.y })
                      .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                      .text(function(d){ return d.data.key })
                      .style("fill", function(d) {
                        if(d.r < 30) return "none";
                        else return "black";
                      })
                      .attr("class", "labels_text")
                      .attr("text-anchor", "middle")
                      .style("font-size", 15)
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .style("opacity", 1)


                      /// button play


              } // drawInitialPack

              drawInitialPack();

              var playButton = d3.select("#action")

              playButton.on("click", function() {
                var button = d3.select(this)

                if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }
                 timer = d3.interval(transitionSports, 4000)

                  function transitionSports() {
                    d3.selectAll("line").remove()
                     var new_filtered_data = data.filter(function(d) {
                           return (d["Award Year"] == years[counter]) && (d["Theme"] == "Environment")
                          })

                    var something = document.getElementById("menu").value = years[counter]



                    var new_nested_grants = d3.nest()
                      .key(function(d) { return d["Funding Org:Name"]})
                      .key(function(d) { return d["Recipient Org:Name"] })
                      .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                      .entries(new_filtered_data)

                      var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                      var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                      .sum(function(d) { return d.value })
                                      .sort(function(a, b) { return b.value - a.value; })

                        var new_data_nodes = packLayout(newRootNode).descendants()

                      var circle = g.selectAll("circle")
                         .data(new_data_nodes)

                       var text_background = g.selectAll(".text")
                           .data(new_data_nodes.filter(function(d) { return !!d.children }))

                       var text = g.selectAll(".labels")
                           .data(new_data_nodes.filter(function(d) { return !!d.children }))

                            if(g.select(".years")._groups[0][0]) {
                              g.select(".years")
                                .attr("x", w / 2)
                                .attr("y", 20)
                                .text(years[counter])
                            }
                            else {
                              g.append("text")
                                .attr("class", "years")
                                .attr("x", w / 2)
                                .attr("y", 20)
                                .text(years[counter])
                            }

                    var circleTransition =  d3.transition()
                         .duration(1000)

                     var textTransition = d3.transition()
                         .duration(1000)

                     // exit
                     circle.exit()
                         .style("fill", function(d) { return d.children ? colorCircleEnvironment(d.depth) : "white"; })
                         .transition(circleTransition)
                         .attr("r", function(d) { return 0 })
                         .remove()

                       d3.selectAll(".labels_text")
                       .remove();

                       d3.selectAll(".labels_background")
                       .remove();

                       d3.selectAll(".slider_years")
                       .remove()

                       // d3.selectAll(".years")
                       // .remove()

                     // update
                     circle.transition(circleTransition)
                         .style("fill", function(d) { return d.children ? colorCircleEnvironment(d.depth) : "white"; })
                         .attr("class", "circle_packs")
                         .attr("r", function(d) { return d.r })
                         .attr("cx", function(d) { return d.x })
                         .attr("cy", function(d) { return  d.y })
                         .style("opacity", 1)

                     text_background.transition(textTransition)
                         .attr("x", function(d){ return d.x; })
                         .attr("y", function(d){ return d.y; });

                       text.transition(textTransition)
                         .attr("x", function(d){ return d.x; })
                         .attr("y", function(d){ return d.y; });

                       //enter
                       circle.enter()
                       .append("circle")
                       .attr("r", function(d) { return 0 })
                       .attr("cx", function(d) { return d.x })
                       .attr("cy", function(d) { return  d.y })
                       .style("fill", function(d) { return d.children ? colorCircleEnvironment(d.depth) : "white"; })
                       .transition(circleTransition)
                       .attr("r", function(d) { return d.r })
                       .style("fill", function(d) { return d.children ? colorCircleEnvironment(d.depth) : "white"; })

                       text_background.enter()
                         .append("text")
                         .attr("opacity", 0)
                         .attr("class", "labels_background")
                         .attr("x", function(d) {
                           if(d.data.key == "The Wellcome Trust") return d.x - 20;
                           else return d.x
                         })
                         .attr("y", function(d) {
                           if(d.data.key == "The Wellcome Trust" && years[counter] == 2014) return d.y - 10;
                           else return d.y
                         })
                         .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                         .text(function(d){ return d.data.key })
                         .style("fill", "none")
                         .style("font-size", 15)
                         .style("stroke-width", 15*0.2)
                         .style("stroke", function(d) {
                           if(d.r < 30) return "none";
                           else return "#ffffff";
                         })
                         .attr("text-anchor", "middle")
                         .transition(textTransition)
                         .style("opacity", 1)

                         text.enter()
                           .append("text")
                           .attr("opacity", 0)
                           .attr("class", "labels_text")
                           .attr("x", function(d) {
                            if(d.data.key == "The Wellcome Trust") return d.x - 20;
                              else return d.x
                            })
                            .attr("y", function(d) {
                              if(d.data.key == "The Wellcome Trust" && years[counter] == 2014) return d.y - 10;
                                else return d.y
                              })
                           .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                           .text(function(d){ return d.data.key })
                           .style("fill", function(d) {
                             if(d.r < 30) return "none";
                             else return "black";
                           })
                           .attr("text-anchor", "middle")
                           .style("font-size", 15)
                           .transition(textTransition)
                           .style("opacity", 1)

                         counter += 1
                         if (counter === years.length) {
                          timer.stop()
                         }
                 }// transition

                  d3.select("#action")
                  .on("click", function() {
                    timer.stop()
                  })

              }) // action



                function drawFilteredPack(){
                  d3.selectAll("circle")
                  .remove()
                  d3.selectAll("line").remove()

                  d3.selectAll("text")
                  .remove()

                  if(timer == undefined) {
                  }
                  else {
                    timer.stop()
                  }

                  var selectedYear = document.getElementById("menu").value;

                  var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Environment") })

                  var nested_grants = d3.nest()
                    .key(function(d) { return d["Funding Org:Name"]})
                    .key(function(d) { return d["Recipient Org:Name"] })
                    .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                    .entries(filteredDataYear)

                    var packableGrants = {key: "All Grants", values: nested_grants}

                    var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                    .sum(function(d) { return d.value })
                                    .sort(function(a, b) { return b.value - a.value; })

                     var data_nodes = packLayout(rootNode).descendants()




                    g.selectAll("circle")
                    .data(data_nodes)
                    .enter()
                    .append("circle")
                    .attr("r", function(d) {
                       return 0;
                     })
                    .attr("cx", function(d) { return d.x })
                    .attr("cy", function(d) { return  d.y })
                    .style("fill", function(d) { return d.children ? colorCircleEnvironment(d.depth) : "white"; })
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .attr("r", function(d) { return d.r })
                    .style("opacity", 1)




                    g.selectAll(".text")
                      .data(data_nodes.filter(function(d) { return !!d.children }))
                      .enter()
                      .append("text")
                      .attr("x", function(d) {
                        if(d.data.key == "The Wellcome Trust") return d.x - 20;
                        else return d.x
                      })
                      .attr("y", function(d) {
                        if(d.data.key == "The Wellcome Trust" && selectedYear == 2014) return d.y - 10;
                        else return d.y
                      })
                      .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                      .text(function(d){ return d.data.key })
                      .style("fill", "none")
                      .attr("class", "labels_background")
                      .style("font-size", 15)
                      .style("stroke-width", 15*0.2)
                      .style("stroke", function(d) {
                        if(d.r < 30) return "none";
                        else return "#ffffff";
                      })
                      .attr("text-anchor", "middle")
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .style("opacity", 1)


                    g.selectAll(".labels")
                      .data(data_nodes.filter(function(d) { return !!d.children }))
                      .enter()
                      .append("text")
                      .attr("x", function(d) {
                        if(d.data.key == "The Wellcome Trust") return d.x - 20;
                        else return d.x
                      })
                      .attr("y", function(d) {
                        if(d.data.key == "The Wellcome Trust" && selectedYear == 2014) return d.y - 10;
                        else return d.y
                      })
                      .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                      .text(function(d){ return d.data.key })
                      .style("fill", function(d) {
                        if(d.r < 30) return "none";
                        else return "black";
                      })
                      .attr("class", "labels_text")
                      .attr("text-anchor", "middle")
                      .style("font-size", 15)
                      .raise()
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .style("opacity", 1);

                      g.append("text")
                                .attr("class", "slider_years")
                                .attr("x", w / 2)
                                .attr("y", 20)
                                .text(selectedYear)


                }

                d3.select("#menu")
                  .on("input", function() {
                    drawFilteredPack();
                  })

  }) // environment

  // Science

    d3.select("#science").on("click", function() {
      d3.selectAll("circle")
                .remove()
                d3.selectAll("text")
                .remove()
                d3.selectAll("line").remove()
                if(timer) {
               timer.stop()
              }
              document.getElementById("menu").value = 2004
                function drawInitialPack(){
                  years = d3.range(2004, 2019)

                  var filter_data = data.filter(function(d) {
                    return (d["Award Year"] == years[0]) && (d["Theme"] == "Science")
                  })

                  d3.select("#sports").style("background-color", "white").style("color", "black")
                  d3.select("#health").style("background-color", "white").style("color", "black")
                  d3.select("#education").style("background-color", "white").style("color", "black")
                  d3.select("#arts").style("background-color", "white").style("color", "black")
                  d3.select("#transportation").style("background-color", "white").style("color", "black")
                  d3.select("#environment").style("background-color", "white").style("color", "black")
                  d3.select("#science").style("background-color", "#551a8b").style("color", "white")
                  d3.select("#homelessness").style("background-color", "white").style("color", "black")
                  d3.select("#veterans").style("background-color", "white").style("color", "black")

                  var nested_grants = d3.nest()
                    .key(function(d) { return d["Funding Org:Name"]})
                    .key(function(d) { return d["Recipient Org:Name"] })
                    .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                    .entries(filter_data)

                    var packableGrants = {key: "All Grants", values: nested_grants}

                    var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                    .sum(function(d) { return d.value })
                                    .sort(function(a, b) { return b.value - a.value; })

                      var sizeScale = d3.scaleSqrt()
                      .range([0.0001,0.01]);

                      packLayout.radius(d=>sizeScale(d.value));


                      var data_nodes = packLayout(rootNode).descendants()
                      pack.radius
                      g.selectAll("circle")
                      .data(data_nodes)
                      .enter()
                      .append("circle")
                      .attr("class", "circle_packs")
                      .attr("r", function(d) { return 0 })
                      .attr("cx", function(d) { return d.x })
                      .attr("cy", function(d) { return  d.y })
                      .style("fill", function(d) { return d.children ? colorCircleScience(d.depth) : "white"; })
                      .transition()
                      .duration(1000)
                      .attr("r", function(d) { return d.r })


                      g.selectAll(".text")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", "none")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .attr("class", "labels_background")
                        .style("stroke-width", 15*0.2)
                        .style("stroke", function(d) {
                          if(d.r < 30) return "none";
                          else return "#ffffff";
                        })
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)


                        g.append("text")
                        .attr("class", "years")
                        .attr("x", w / 2)
                        .attr("y", 20)
                        .text(years[0])


                      g.selectAll(".labels")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", function(d) {
                          if(d.r < 30) return "none";
                          else return "black";
                        })
                        .attr("class", "labels_text")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)


                        /// button play


                } // drawInitialPack

                drawInitialPack();

                var playButton = d3.select("#action")

                playButton.on("click", function() {
                  var button = d3.select(this)

                    if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }
                   timer = d3.interval(transitionSports, 4000)

                    function transitionSports() {
                      d3.selectAll("line").remove()
                       var new_filtered_data = data.filter(function(d) {
                             return (d["Award Year"] == years[counter]) && (d["Theme"] == "Science")
                            })

                      var something = document.getElementById("menu").value = years[counter]



                      var new_nested_grants = d3.nest()
                        .key(function(d) { return d["Funding Org:Name"]})
                        .key(function(d) { return d["Recipient Org:Name"] })
                        .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                        .entries(new_filtered_data)

                        var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                        var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                        .sum(function(d) { return d.value })
                                        .sort(function(a, b) { return b.value - a.value; })

                          var new_data_nodes = packLayout(newRootNode).descendants()

                        var circle = g.selectAll("circle")
                           .data(new_data_nodes)

                         var text_background = g.selectAll(".text")
                             .data(new_data_nodes.filter(function(d) { return !!d.children }))

                         var text = g.selectAll(".labels")
                             .data(new_data_nodes.filter(function(d) { return !!d.children }))

                              if(g.select(".years")._groups[0][0]) {
                                g.select(".years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(years[counter])
                              }
                              else {
                                g.append("text")
                                  .attr("class", "years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(years[counter])
                              }

                      var circleTransition =  d3.transition()
                           .duration(1000)

                       var textTransition = d3.transition()
                           .duration(1000)


                      if (years[counter] == 2005) {
                        g.append("text")
                          .attr("x",  0)
                          .attr("y", 50)
                          .text("The Wellcome Trust accounted for 96% of amount given in grants for the science theme.")
                          .style("font-size", 15)
                          .attr("class", "science_label")
                          .style("opacity", 0)
                          .transition()
                          .duration(2000)
                          .style("opacity", 1)
                      }



                       // exit
                       circle.exit()
                           .style("fill", function(d) { return d.children ? colorCircleScience(d.depth) : "white"; })
                           .transition(circleTransition)
                           .attr("r", function(d) { return 0 })
                           .remove()

                         d3.selectAll(".labels_text")
                         .remove();

                         d3.selectAll(".labels_background")
                         .remove();

                         d3.selectAll(".slider_years")
                         .remove()

                         // d3.selectAll(".years")
                         // .remove()

                       // update
                       circle.transition(circleTransition)
                           .style("fill", function(d) { return d.children ? colorCircleScience(d.depth) : "white"; })
                           .attr("class", "circle_packs")
                           .attr("r", function(d) { return d.r })
                           .attr("cx", function(d) { return d.x })
                           .attr("cy", function(d) { return  d.y })
                           .style("opacity", 1)

                       text_background.transition(textTransition)
                           .attr("x", function(d){ return d.x; })
                           .attr("y", function(d){ return d.y; });

                         text.transition(textTransition)
                           .attr("x", function(d){ return d.x; })
                           .attr("y", function(d){ return d.y; });

                         //enter
                         circle.enter()
                         .append("circle")
                         .attr("r", function(d) { return 0 })
                         .attr("cx", function(d) { return d.x })
                         .attr("cy", function(d) { return  d.y })
                         .style("fill", function(d) { return d.children ? colorCircleScience(d.depth) : "white"; })
                         .transition(circleTransition)
                         .attr("r", function(d) { return d.r })
                         .style("fill", function(d) { return d.children ? colorCircleScience(d.depth) : "white"; })

                         text_background.enter()
                           .append("text")
                           .attr("opacity", 0)
                           .attr("class", "labels_background")
                           .attr("x", function(d) { return d.x })
                           .attr("y", function(d) { return d.y })
                           .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                           .text(function(d){ return d.data.key })
                           .style("fill", "none")
                           .style("font-size", 15)
                           .style("stroke-width", 15*0.2)
                           .style("stroke", function(d) {
                             if(d.r < 30) return "none";
                             else return "#ffffff";
                           })
                           .attr("text-anchor", "middle")
                           .transition(textTransition)
                           .style("opacity", 1)

                           text.enter()
                             .append("text")
                             .attr("opacity", 0)
                             .attr("class", "labels_text")
                             .attr("x", function(d) { return d.x })
                             .attr("y", function(d) { return d.y })
                             .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                             .text(function(d){ return d.data.key })
                             .style("fill", function(d) {
                               if(d.r < 30) return "none";
                               else return "black";
                             })
                             .attr("text-anchor", "middle")
                             .style("font-size", 15)
                             .transition(textTransition)
                             .style("opacity", 1)

                           counter += 1
                           if (counter === years.length) {
                            timer.stop()
                           }
                   }// transition

                    d3.select("#action")
                    .on("click", function() {
                      timer.stop()
                    })

                }) // action



                  function drawFilteredPack(){
                    d3.selectAll("line").remove()
                    d3.selectAll("circle")
                    .remove()

                    d3.selectAll("text")
                    .remove()

                    if(timer == undefined) {
                    }
                    else {
                      timer.stop()
                    }

                    var selectedYear = document.getElementById("menu").value;

                    var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Science") })

                    var nested_grants = d3.nest()
                      .key(function(d) { return d["Funding Org:Name"]})
                      .key(function(d) { return d["Recipient Org:Name"] })
                      .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                      .entries(filteredDataYear)

                      var packableGrants = {key: "All Grants", values: nested_grants}

                      var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                      .sum(function(d) { return d.value })
                                      .sort(function(a, b) { return b.value - a.value; })

                       var data_nodes = packLayout(rootNode).descendants()




                      g.selectAll("circle")
                      .data(data_nodes)
                      .enter()
                      .append("circle")
                      .attr("r", function(d) {
                         return 0;
                       })
                      .attr("cx", function(d) { return d.x })
                      .attr("cy", function(d) { return  d.y })
                      .style("fill", function(d) { return d.children ? colorCircleScience(d.depth) : "white"; })
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .attr("r", function(d) { return d.r })
                      .style("opacity", 1)




                      g.selectAll(".text")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x  })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", "none")
                        .attr("class", "labels_background")
                        .style("font-size", 15)
                        .style("stroke-width", 15*0.2)
                        .style("stroke", function(d) {
                          if(d.r < 30) return "none";
                          else return "#ffffff";
                        })
                        .attr("text-anchor", "middle")
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)


                      g.selectAll(".labels")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", function(d) {
                          if(d.r < 30) return "none";
                          else return "black";
                        })
                        .attr("class", "labels_text")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .raise()
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1);

                        g.append("text")
                                  .attr("class", "slider_years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(selectedYear)



                  }

                  d3.select("#menu")
                    .on("input", function() {
                      drawFilteredPack();
                    })

    }) // Science

  // Homelessness

    d3.select("#homelessness").on("click", function() {
      d3.selectAll("circle")
                .remove()
                d3.selectAll("line").remove()
                d3.selectAll("text")
                .remove()
                if(timer) {
               timer.stop()
              }
              document.getElementById("menu").value = 2004

              d3.select("#sports").style("background-color", "white").style("color", "black")
              d3.select("#health").style("background-color", "white").style("color", "black")
              d3.select("#education").style("background-color", "white").style("color", "black")
              d3.select("#arts").style("background-color", "white").style("color", "black")
              d3.select("#transportation").style("background-color", "white").style("color", "black")
              d3.select("#environment").style("background-color", "white").style("color", "black")
              d3.select("#science").style("background-color", "white").style("color", "black")
              d3.select("#homelessness").style("background-color", "#800000").style("color", "white")
              d3.select("#veterans").style("background-color", "white").style("color", "black")

                function drawInitialPack(){
                  years = d3.range(2004, 2019)

                  var filter_data = data.filter(function(d) {
                    return (d["Award Year"] == years[0]) && (d["Theme"] == "Homelessness")
                  })

                  var nested_grants = d3.nest()
                    .key(function(d) { return d["Funding Org:Name"]})
                    .key(function(d) { return d["Recipient Org:Name"] })
                    .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                    .entries(filter_data)

                    var packableGrants = {key: "All Grants", values: nested_grants}

                    var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                    .sum(function(d) { return d.value })
                                    .sort(function(a, b) { return b.value - a.value; })

                      var sizeScale = d3.scaleSqrt()
                      .range([0.0001,0.01]);

                      packLayout.radius(d=>sizeScale(d.value));


                      var data_nodes = packLayout(rootNode).descendants()
                      pack.radius
                      g.selectAll("circle")
                      .data(data_nodes)
                      .enter()
                      .append("circle")
                      .attr("class", "circle_packs")
                      .attr("r", function(d) { return 0 })
                      .attr("cx", function(d) { return d.x })
                      .attr("cy", function(d) { return  d.y })
                      .style("fill", function(d) { return d.children ? colorCircleHomelessness(d.depth) : "white"; })
                      .transition()
                      .duration(1000)
                      .attr("r", function(d) { return d.r })


                      g.selectAll(".text")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", "none")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .attr("class", "labels_background")
                        .style("stroke-width", 15*0.2)
                        .style("stroke", function(d) {
                          if(d.r < 30) return "none";
                          else return "#ffffff";
                        })
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)

                        g.append("text")
                        .attr("class", "years")
                        .attr("x", w / 2)
                        .attr("y", 20)
                        .text(years[0])


                      g.selectAll(".labels")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", function(d) {
                          if(d.r < 30) return "none";
                          else return "black";
                        })
                        .attr("class", "labels_text")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)

                        /// button play


                } // drawInitialPack

                drawInitialPack();

                var playButton = d3.select("#action")

                playButton.on("click", function() {
                  var button = d3.select(this)

                    if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }
                   timer = d3.interval(transitionSports, 4000)

                    function transitionSports() {
                      d3.selectAll("line").remove()
                       var new_filtered_data = data.filter(function(d) {
                             return (d["Award Year"] == years[counter]) && (d["Theme"] == "Homelessness")
                            })

                      var something = document.getElementById("menu").value = years[counter]



                      var new_nested_grants = d3.nest()
                        .key(function(d) { return d["Funding Org:Name"]})
                        .key(function(d) { return d["Recipient Org:Name"] })
                        .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                        .entries(new_filtered_data)

                        var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                        var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                        .sum(function(d) { return d.value })
                                        .sort(function(a, b) { return b.value - a.value; })

                          var new_data_nodes = packLayout(newRootNode).descendants()

                        var circle = g.selectAll("circle")
                           .data(new_data_nodes)

                         var text_background = g.selectAll(".text")
                             .data(new_data_nodes.filter(function(d) { return !!d.children }))

                         var text = g.selectAll(".labels")
                             .data(new_data_nodes.filter(function(d) { return !!d.children }))

                              if(g.select(".years")._groups[0][0]) {
                                g.select(".years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(years[counter])
                              }
                              else {
                                g.append("text")
                                  .attr("class", "years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(years[counter])
                              }

                      var circleTransition =  d3.transition()
                           .duration(1000)

                       var textTransition = d3.transition()
                           .duration(1000)

                       // exit
                       circle.exit()
                           .style("fill", function(d) { return d.children ? colorCircleHomelessness(d.depth) : "white"; })
                           .transition(circleTransition)
                           .attr("r", function(d) { return 0 })
                           .remove()

                         d3.selectAll(".labels_text")
                         .remove();

                         d3.selectAll(".labels_background")
                         .remove();

                         d3.selectAll(".slider_years")
                         .remove()

                         // d3.selectAll(".years")
                         // .remove()

                       // update
                       circle.transition(circleTransition)
                           .style("fill", function(d) { return d.children ? colorCircleHomelessness(d.depth) : "white"; })
                           .attr("class", "circle_packs")
                           .attr("r", function(d) { return d.r })
                           .attr("cx", function(d) { return d.x })
                           .attr("cy", function(d) { return  d.y })
                           .style("opacity", 1)

                       text_background.transition(textTransition)
                           .attr("x", function(d){ return d.x; })
                           .attr("y", function(d){ return d.y; });

                         text.transition(textTransition)
                           .attr("x", function(d){ return d.x; })
                           .attr("y", function(d){ return d.y; });

                         //enter
                         circle.enter()
                         .append("circle")
                         .attr("r", function(d) { return 0 })
                         .attr("cx", function(d) { return d.x })
                         .attr("cy", function(d) { return  d.y })
                         .style("fill", function(d) { return d.children ? colorCircleHomelessness(d.depth) : "white"; })
                         .transition(circleTransition)
                         .attr("r", function(d) { return d.r })
                         .style("fill", function(d) { return d.children ? colorCircleHomelessness(d.depth) : "white"; })

                         text_background.enter()
                           .append("text")
                           .attr("opacity", 0)
                           .attr("class", "labels_background")
                           .attr("x", function(d) { return d.x })
                           .attr("y", function(d) { return d.y })
                           .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                           .text(function(d){ return d.data.key })
                           .style("fill", "none")
                           .style("font-size", 15)
                           .style("stroke-width", 15*0.2)
                           .style("stroke", function(d) {
                             if(d.r < 30) return "none";
                             else return "#ffffff";
                           })
                           .attr("text-anchor", "middle")
                           .transition(textTransition)
                           .style("opacity", 1)

                           text.enter()
                             .append("text")
                             .attr("opacity", 0)
                             .attr("class", "labels_text")
                             .attr("x", function(d) { return d.x })
                             .attr("y", function(d) { return d.y })
                             .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                             .text(function(d){ return d.data.key })
                             .style("fill", function(d) {
                               if(d.r < 30) return "none";
                               else return "black";
                             })
                             .attr("text-anchor", "middle")
                             .style("font-size", 15)
                             .transition(textTransition)
                             .style("opacity", 1)

                           counter += 1
                           if (counter === years.length) {
                            timer.stop()
                           }
                   }// transition

                    d3.select("#action")
                    .on("click", function() {
                      timer.stop()
                    })

                }) // action



                  function drawFilteredPack(){
                    d3.selectAll("line").remove()
                    d3.selectAll("circle")
                    .remove()

                    d3.selectAll("text")
                    .remove()

                    if(timer == undefined) {
                    }
                    else {
                      timer.stop()
                    }

                    var selectedYear = document.getElementById("menu").value;

                    var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Homelessness") })

                    var nested_grants = d3.nest()
                      .key(function(d) { return d["Funding Org:Name"]})
                      .key(function(d) { return d["Recipient Org:Name"] })
                      .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                      .entries(filteredDataYear)

                      var packableGrants = {key: "All Grants", values: nested_grants}

                      var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                      .sum(function(d) { return d.value })
                                      .sort(function(a, b) { return b.value - a.value; })

                       var data_nodes = packLayout(rootNode).descendants()




                      g.selectAll("circle")
                      .data(data_nodes)
                      .enter()
                      .append("circle")
                      .attr("r", function(d) {
                         return 0;
                       })
                      .attr("cx", function(d) { return d.x })
                      .attr("cy", function(d) { return  d.y })
                      .style("fill", function(d) { return d.children ? colorCircleHomelessness(d.depth) : "white"; })
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .attr("r", function(d) { return d.r })
                      .style("opacity", 1)




                      g.selectAll(".text")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x  })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", "none")
                        .attr("class", "labels_background")
                        .style("font-size", 15)
                        .style("stroke-width", 15*0.2)
                        .style("stroke", function(d) {
                          if(d.r < 30) return "none";
                          else return "#ffffff";
                        })
                        .attr("text-anchor", "middle")
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)


                      g.selectAll(".labels")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", function(d) {
                          if(d.r < 30) return "none";
                          else return "black";
                        })
                        .attr("class", "labels_text")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .raise()
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1);

                        g.append("text")
                                  .attr("class", "slider_years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(selectedYear)



                  }

                  d3.select("#menu")
                    .on("input", function() {
                      drawFilteredPack();
                    })

    }) // Homelessness

  // Veterans

    d3.select("#veterans").on("click", function() {
      d3.selectAll("circle")
                .remove()
                d3.selectAll("text")
                .remove()
                d3.selectAll("line").remove()
                if(timer) {
               timer.stop()
              }
              document.getElementById("menu").value = 2004

              d3.select("#sports").style("background-color", "white").style("color", "black")
              d3.select("#health").style("background-color", "white").style("color", "black")
              d3.select("#education").style("background-color", "white").style("color", "black")
              d3.select("#arts").style("background-color", "white").style("color", "black")
              d3.select("#transportation").style("background-color", "white").style("color", "black")
              d3.select("#environment").style("background-color", "white").style("color", "black")
              d3.select("#science").style("background-color", "white").style("color", "black")
              d3.select("#homelessness").style("background-color", "white").style("color", "black")
              d3.select("#veterans").style("background-color", "#6666b2").style("color", "white")

                function drawInitialPack(){
                  years = d3.range(2004, 2019)

                  var filter_data = data.filter(function(d) {
                    return (d["Award Year"] == years[0]) && (d["Theme"] == "Veterans")
                  })

                  var nested_grants = d3.nest()
                    .key(function(d) { return d["Funding Org:Name"]})
                    .key(function(d) { return d["Recipient Org:Name"] })
                    .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                    .entries(filter_data)

                    var packableGrants = {key: "All Grants", values: nested_grants}

                    var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                    .sum(function(d) { return d.value })
                                    .sort(function(a, b) { return b.value - a.value; })

                      var sizeScale = d3.scaleSqrt()
                      .range([0.0001,0.01]);

                      packLayout.radius(d=>sizeScale(d.value));


                      var data_nodes = packLayout(rootNode).descendants()
                      pack.radius
                      g.selectAll("circle")
                      .data(data_nodes)
                      .enter()
                      .append("circle")
                      .attr("class", "circle_packs")
                      .attr("r", function(d) { return 0 })
                      .attr("cx", function(d) { return d.x })
                      .attr("cy", function(d) { return  d.y })
                      .style("fill", function(d) { return d.children ? colorCircleVeterans(d.depth) : "white"; })
                      .transition()
                      .duration(1000)
                      .attr("r", function(d) { return d.r })




                      g.selectAll(".text")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", "none")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .attr("class", "labels_background")
                        .style("stroke-width", 15*0.2)
                        .style("stroke", function(d) {
                          if(d.r < 30) return "none";
                          else return "#ffffff";
                        })
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)

                        g.append("text")
                        .attr("class", "years")
                        .attr("x", w / 2)
                        .attr("y", 20)
                        .text(years[0])


                      g.selectAll(".labels")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", function(d) {
                          if(d.r < 30) return "none";
                          else return "black";
                        })
                        .attr("class", "labels_text")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)

                        /// button play


                } // drawInitialPack

                drawInitialPack();

                var playButton = d3.select("#action")

                playButton.on("click", function() {
                  var button = d3.select(this)

                    if (document.getElementById("menu").value > 2004) {
                    var counter = 0;
                  }
                  else {
                    counter = 1;
                  }
                   timer = d3.interval(transitionSports, 4000)

                    function transitionSports() {
                      d3.selectAll("line").remove()
                       var new_filtered_data = data.filter(function(d) {
                             return (d["Award Year"] == years[counter]) && (d["Theme"] == "Veterans")
                            })

                      var something = document.getElementById("menu").value = years[counter]



                      var new_nested_grants = d3.nest()
                        .key(function(d) { return d["Funding Org:Name"]})
                        .key(function(d) { return d["Recipient Org:Name"] })
                        .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                        .entries(new_filtered_data)

                        var newPackableGrants = {key: "All Grants", values: new_nested_grants}

                        var newRootNode = d3.hierarchy(newPackableGrants, function(d) { return d.values })
                                        .sum(function(d) { return d.value })
                                        .sort(function(a, b) { return b.value - a.value; })

                          var new_data_nodes = packLayout(newRootNode).descendants()

                        var circle = g.selectAll("circle")
                           .data(new_data_nodes)

                         var text_background = g.selectAll(".text")
                             .data(new_data_nodes.filter(function(d) { return !!d.children }))

                         var text = g.selectAll(".labels")
                             .data(new_data_nodes.filter(function(d) { return !!d.children }))

                              if(g.select(".years")._groups[0][0]) {
                                g.select(".years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(years[counter])
                              }
                              else {
                                g.append("text")
                                  .attr("class", "years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(years[counter])
                              }

                      var circleTransition =  d3.transition()
                           .duration(1000)

                       var textTransition = d3.transition()
                           .duration(1000)

                       // exit
                       circle.exit()
                           .style("fill", function(d) { return d.children ? colorCircleVeterans(d.depth) : "white"; })
                           .transition(circleTransition)
                           .attr("r", function(d) { return 0 })
                           .remove()

                         d3.selectAll(".labels_text")
                         .remove();

                         d3.selectAll(".labels_background")
                         .remove();

                         d3.selectAll(".slider_years")
                         .remove()

                         // d3.selectAll(".years")
                         // .remove()

                       // update
                       circle.transition(circleTransition)
                           .style("fill", function(d) { return d.children ? colorCircleVeterans(d.depth) : "white"; })
                           .attr("class", "circle_packs")
                           .attr("r", function(d) { return d.r })
                           .attr("cx", function(d) { return d.x })
                           .attr("cy", function(d) { return  d.y })
                           .style("opacity", 1)

                       text_background.transition(textTransition)
                           .attr("x", function(d){ return d.x; })
                           .attr("y", function(d){ return d.y; });

                         text.transition(textTransition)
                           .attr("x", function(d){ return d.x; })
                           .attr("y", function(d){ return d.y; });

                         //enter
                         circle.enter()
                         .append("circle")
                         .attr("r", function(d) { return 0 })
                         .attr("cx", function(d) { return d.x })
                         .attr("cy", function(d) { return  d.y })
                         .style("fill", function(d) { return d.children ? colorCircleVeterans(d.depth) : "white"; })
                         .transition(circleTransition)
                         .attr("r", function(d) { return d.r })
                         .style("fill", function(d) { return d.children ? colorCircleVeterans(d.depth) : "white"; })

                         text_background.enter()
                           .append("text")
                           .attr("opacity", 0)
                           .attr("class", "labels_background")
                           .attr("x", function(d) { return d.x })
                           .attr("y", function(d) { return d.y })
                           .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                           .text(function(d){ return d.data.key })
                           .style("fill", "none")
                           .style("font-size", 15)
                           .style("stroke-width", 15*0.2)
                           .style("stroke", function(d) {
                             if(d.r < 30) return "none";
                             else return "#ffffff";
                           })
                           .attr("text-anchor", "middle")
                           .transition(textTransition)
                           .style("opacity", 1)

                           text.enter()
                             .append("text")
                             .attr("opacity", 0)
                             .attr("class", "labels_text")
                             .attr("x", function(d) { return d.x })
                             .attr("y", function(d) { return d.y })
                             .style("display", function(d) { return d.parent == newRootNode ? "inline" : "none"})
                             .text(function(d){ return d.data.key })
                             .style("fill", function(d) {
                               if(d.r < 30) return "none";
                               else return "black";
                             })
                             .attr("text-anchor", "middle")
                             .style("font-size", 15)
                             .transition(textTransition)
                             .style("opacity", 1)

                           counter += 1
                           if (counter === years.length) {
                            timer.stop()
                           }
                   }// transition

                    d3.select("#action")
                    .on("click", function() {
                      timer.stop()
                    })

                }) // action



                  function drawFilteredPack(){
                    d3.selectAll("circle")
                    .remove()

                    d3.selectAll("line").remove()

                    d3.selectAll("text")
                    .remove()

                    if(timer == undefined) {
                    }
                    else {
                      timer.stop()
                    }

                    var selectedYear = document.getElementById("menu").value;

                    var filteredDataYear = data.filter(function(d) {return (d["Award Year"] == selectedYear) && (d["Theme"] == "Veterans") })

                    var nested_grants = d3.nest()
                      .key(function(d) { return d["Funding Org:Name"]})
                      .key(function(d) { return d["Recipient Org:Name"] })
                      .rollup(function(d) { return d3.sum(d, function(d) { return d["Amount Awarded"] })})
                      .entries(filteredDataYear)

                      var packableGrants = {key: "All Grants", values: nested_grants}

                      var rootNode = d3.hierarchy(packableGrants, function(d) { return d.values })
                                      .sum(function(d) { return d.value })
                                      .sort(function(a, b) { return b.value - a.value; })

                       var data_nodes = packLayout(rootNode).descendants()




                      g.selectAll("circle")
                      .data(data_nodes)
                      .enter()
                      .append("circle")
                      .attr("r", function(d) {
                         return 0;
                       })
                      .attr("cx", function(d) { return d.x })
                      .attr("cy", function(d) { return  d.y })
                      .style("fill", function(d) { return d.children ? colorCircleVeterans(d.depth) : "white"; })
                      .style("opacity", 0)
                      .transition()
                      .duration(1000)
                      .attr("r", function(d) { return d.r })
                      .style("opacity", 1)




                      g.selectAll(".text")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x  })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", "none")
                        .attr("class", "labels_background")
                        .style("font-size", 15)
                        .style("stroke-width", 15*0.2)
                        .style("stroke", function(d) {
                          if(d.r < 30) return "none";
                          else return "#ffffff";
                        })
                        .attr("text-anchor", "middle")
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1)


                      g.selectAll(".labels")
                        .data(data_nodes.filter(function(d) { return !!d.children }))
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x })
                        .attr("y", function(d) { return d.y })
                        .style("display", function(d) { return d.parent == rootNode ? "inline" : "none"})
                        .text(function(d){ return d.data.key })
                        .style("fill", function(d) {
                          if(d.r < 30) return "none";
                          else return "black";
                        })
                        .attr("class", "labels_text")
                        .attr("text-anchor", "middle")
                        .style("font-size", 15)
                        .raise()
                        .style("opacity", 0)
                        .transition()
                        .duration(1000)
                        .style("opacity", 1);

                        g.append("text")
                                  .attr("class", "slider_years")
                                  .attr("x", w / 2)
                                  .attr("y", 20)
                                  .text(selectedYear)



                  }

                  d3.select("#menu")
                    .on("input", function() {
                      drawFilteredPack();
                    })

    }) // Veterans


  })


</script>

</body>
</html>