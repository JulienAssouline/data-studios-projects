<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
   <link href="https://fonts.googleapis.com/css?family=Playfair+Display" rel="stylesheet">
   <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
 <style type="text/css">
      /* No style rules here yet */
body,html{
    margin: 0;
    padding: 0;
    font-family: "Arial", sans-serif;
    font-size: 11px;
    text-align: center;
  }

  #dropdown_provinces{
  position: absolute;
  width: 50%;
  top: -20px;
  left: 0px;
}
#dropdown_city{
  position: absolute;
  width: 50%;
  top: 0px;
  left: 0px;
}
.axisx path {
    fill: none;
    stroke: white;
    stroke-width: 2px;
    shape-rendering: crispEdges;
  }
  .axisx line {
    fill: none;
    stroke: grey;
  }
.axisy path {
    fill: none;
    stroke: white;
  }
.axisy line{
    fill: none;
    stroke: #dcd9d3;
    stroke-width: 1px;
    shape-rendering: crispEdges;
    opacity: 0.7;
    stroke-dasharray: 3,3;
  }
.year_label{
  font-size: 15px;
}
#animating{
  stroke: red;
}

#wrapper{
   position: absolute;
  top: 130px;
}

h2{
  font-size: 20px;
}

  </style>
  </head>
  <body>
  <h2> Explore how your city's climate has changed over the years </h2>
  <div id = "wrapper"></div>

  <script>


var w = 700;
var h = 500;
var counter;
var timer;
var years;
var onLoad = false;

var margin = {
  left: 40,
  right: 40,
  top: 40,
  bottom: 40
}

var width = w - margin.left - margin.right,
    height = h - margin.top - margin.bottom;

var wrapper = d3.select("#wrapper")

 var svg = wrapper.append("svg")
    .attr("id", "chart")
    .attr("width", w)
    .attr("height", h)

   var g = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var parseMonth = d3.timeParse("%b")



    d3.csv("Canadian_cities_climate.csv", function(error, data){

      data = data.filter(function(d){
        if(isNaN(d.Temperature)){
            return false;
        }
        return true;
      });

      data.forEach(function(d) {
        d.Temperature = +d.Temperature
        d.Annual = +d.Annual
        d.Month = parseMonth(d.Month)
      })
    d3.csv("provinces_cities.csv", function(error, cities_provinces){



    var unique_province = [...new Set(data.map(d => d.Province))];
    years = [...new Set(data.map(d => d.Year))];

   var provinces_dropdown = wrapper.append("select").attr("id", "dropdown_provinces")
      .selectAll(".provinces")
      .data(unique_province)
      .enter()
      .append("option")
      .attr("value", function(d){
        return d
      })
      .attr("selected", function(d) {
        if (d == "ON") return "selected";
      })
      .html(function(d){
        return d
      })
      .attr("id", function(d){
        if (d== "ON") return "True"
        else return "False"
      })





     var dropdown = document.getElementById("dropdown_provinces")

     var selected_province = [];
     dropdown.childNodes.forEach(function(d) {
      if (d.selected == true) {
        selected_province.push(d)
      }
     })

    var cities_filtered_data = cities_provinces.filter(function(d){ return d.Province == selected_province[0].value })

    // change in province dropdown ///

      d3.select("#dropdown_provinces").on("change", function(e){
       var changed_province = d3.select("#dropdown_provinces").property("value")

      var cities_changed_filtered_data = cities_provinces.filter(function(d){ return d.Province == changed_province })

      updateDropDown(cities_changed_filtered_data)

      // update the chart based on city dropdown //

       d3.select("#dropdown_city").on("change", function(el){

       counter = 0

        var changed_city = d3.select("#dropdown_city").property("value")

       var data_filtered = data.filter(function(d){ return (d.City == changed_city) && (d.Province == changed_province) })

        updateChart(data_filtered)



      })

       var dropdown_city = d3.select("#dropdown_city").property("value")
       var data_filtered_initial = data.filter(function(d){ return (d.City == dropdown_city) && (d.Province == changed_province) })

       // updateChart(data_filtered_initial)

    })

      // updateDropDown(cities_filtered_data)

    function updateDropDown(data_cities) {

      d3.selectAll(".city").remove();

      wrapper.append("select").attr("id", "dropdown_city").attr("class", "city")
       .selectAll(".cities")
       .data(data_cities)
       .enter()
       .append("option")
       .attr("value", function(d) {
         return d.City
       })
       .html(function(d){
         return d.City
       })

    } // updateDropDown

    function updateChart(data_chart){

      // wrapper.append("p")
      //   .html("Your birth year")
      d3.selectAll(".birthyear").remove();

     var text_box = wrapper.append("input")
      .attr("type", "text")
      .attr("id", "birthyear")
      .attr("value", "Your birth year")
      .on("click", function(){
        this.value = ""
      })


      console.log(document.getElementById("birthyear").value)

      // console.log(data_chart)
      // var temp;
      // var year


      // var annual_temp_array = [];
      // data_chart.forEach(function(d) {
      //   if (temp > d.Annual) {

      //   }
      //   annual_temp_array.push(d.Annual)
      // temp = d.Annual
      // })



      d3.selectAll("text").remove()

     var xScale = d3.scaleTime()
              .range([0, width]);

      var yScale = d3.scaleLinear()
                .range([height, 0])

      var line = d3.line()
              .defined(function(d) { return d.Temperature != 0; })
              .x(function(d) { return xScale(d.Month); })
              .y(function(d) { return yScale(d.Temperature) });

      var xAxis = d3.axisBottom()
          .scale(xScale)
          .ticks(10)
          .tickSizeOuter(0)

        var yAxis = d3.axisLeft()
          .scale(yScale)
          .tickSize(-width,0,0)
          .tickSizeOuter(0)


        // timer = d3.interval(transitionChart, 1000)

        // function transitionChart() {

      var annual_temp = [...new Set(data_chart.map(d => d.Annual))];

     var max_temp = Math.max.apply(null, annual_temp)



     var data_chart_filtered = data_chart.filter(function(d){ return d.Year == years[counter] })

     var data_chart_nest = d3.nest()
      .key(function(d){ return d.Year})
      .entries(data_chart)

       xScale.domain(d3.extent(data_chart, function(d) { return d.Month; }));
      yScale.domain(d3.extent(data_chart, function(d) { return d.Temperature }))

       d3.selectAll("path").remove()

        if(lines_update) {
          lines_update.style("stroke", "grey")
        }

    d3.selectAll(".axisx").remove()

    g.append("g")
            .attr("class", "axisx")


      Date.prototype.getMonthName = function() {
            var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"];
            return months[this.getMonth()];
          };

     g.select(".axisx")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
              .selectAll("text")
              .text(function(d){
                return d.getMonthName();
              })
              .style("font-size", "12px")
              .style("fill", "#707070")

           d3.selectAll(".axisy").remove()

          g.append("g")
              .attr("class", "axisy")

              g.select(".axisy").attr("transform", "translate(0,0)")
              .call(yAxis)
              .selectAll("text")
                  .attr("transform", "translate("+ -5 + ",0)")
                  .style("font-size", "12px")
                  .style("fill", "#707070")


     var lines = g.selectAll("path")
        .data(data_chart_nest)

         lines.exit()
                     .style("stroke", function(d) { return "white"; })
                     .transition()
                     .duration(0)
                     .remove()

    var lines_enter = lines.enter()
        .append("g")
        .attr("class", "nested")

    var lines_update = lines.merge(lines_enter)

    var lines_transition= lines_update.append("path")
        .attr("class", function(d) {
          return d.key
        })
        .attr("d", function(d){
          return line(d.values)
        })
        .style("fill", "none")
        .style("stroke", "red")
        .style("opacity", 0)



        lines_transition.each(function(path, index){



      // var node_temp;
      var temp_anim_array = [];
       d3.select(this)
          .attr("id", function(d) {
            return d.values[0].Annual
          })
          .transition()
          .delay(index * 300)
          .duration(320)
          .style("opacity",1)
          .style("stroke-width", "2px")
          .transition()
          .duration(200)
          .style("stroke", "lightgrey")
          .style("opacity",0.5)
          .style("stroke-width", "1px")
          .on("end", function(d){
            // console.log(this.id)
            // console.log(d.values[0].Annual)
            temp_anim_array.push(this.id)
                    // console.log(this)
                    // console.log(onLoad)

                     if(onLoad == true) {
          d3.selectAll(this).remove()
          // .delay(0)
          // .duration(0)


        }

            // console.log(temp_anim_array)

            // var node_temp = this.id
            //             console.log(node_temp)

            var birthyear = document.getElementById("birthyear").value
            console.log(birthyear)

            if (d.key == birthyear) {
              d3.select(this).style("stroke", "red").style("opacity", 1).style("stroke-width", "2px").style("stroke-dasharray", "2,2")

              g.append("text")
              .attr("x", width + 5)
              .attr("y", yScale(d.values[d.values.length-1].Temperature))
              .text(d.values[d.values.length-1].Year)
            }




             if (d.key == "2017") {
              d3.select(this).style("stroke", "red").style("opacity", 1).style("stroke-width", "2px")

              g.append("text")
              .attr("x", width + 5)
              .attr("y", yScale(d.values[d.values.length-1].Temperature))
              .text(d.values[d.values.length-1].Year)
             }
             if (d.values[0].Annual == max_temp) {
              d3.select(this).style("stroke", "red")
              .style("opacity", 1)
              .style("stroke-width", "2px")
              .style("stroke-dasharray", "2,2")

               g.append("text")
              .attr("x", width + 5)
              .attr("y", yScale(d.values[d.values.length-1].Temperature))
              .text(d.values[d.values.length-1].Year)
             }

          })


          g.append("text")
          .transition()
          .delay(index * 300)
          .duration(320)
            .attr("x", 50)
            .attr("y", 50)
            .text(this.className.animVal)
            .attr("class", "year_label")
            .transition()
          .duration(0.1)
          .style("opacity", 0)
          .on("end", function(){
             if (this.textContent == 2017) {
                d3.select(this).style("opacity", 1)
             }

          })



        }) // linetransition


        //   counter += 1
        // }

        onLoad = true



    } // updateChart





       })// cities_provinces

    }) // data









  </script>


  </body>
</html>